<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=0.8, user-scalable=no">
    <title>佩乐点点勒</title>
    <script type="text/javascript" src="vue.js"></script>
    <script type="text/javascript" src="pako.js"></script>
    <script type="text/javascript" src="break_infinity.js"></script>
    <style>
.space-reset-section {
    background: rgba(0,0,0,0.3);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}
.space-reset-button {
    background: #4a6cf7;
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 16px;
}
.space-reset-button:hover {
    background: #3a5ce7;
}
.reset-locked {
    color: #ff6b6b;
}
.reset-ready {
    color: #4ecdc4;
}
.space-upgrades-tree {
    margin-top: 20px;
}
.upgrade-node {
    margin: 5px 0;
    padding: 5px;
    border-radius: 5px;
    background: rgba(0,0,0,0.2);
}
.upgrade-node.unlocked {
    background: rgba(78,205,196,0.2);
}
.children-container {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-left: 5px;
    padding-left: 5px;
    border-left: 2px dashed #4ecdc4;
}
.upgrade-info {
    min-width: 300px;
}

        body {
            text-align: center;
            font-family: MonospaceTypewriter, monospace;
        }

        button {
            text-align: center;
            font-family: MonospaceTypewriter, monospace;
            font-size: 16px;
        }

        .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 auto;
        max-width: 540px;
        width: 100%;
        background: #ffffff;
        border-radius: 10px;
        }

/* 移动端适配优化 */
        @media (max-width: 540px) {
            .container {
                width: 100%;
            }
        }

        .header-fixed {
            position: sticky;
            top: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            width: 100%;
        }

        .header-text{
            font-weight: bold;
            line-height:150%;
        }

        .tabs {
            display: grid;
            grid-template-columns: repeat(4, minmax(130px,1fr)); /* 4列 */
            grid-auto-rows: minmax(40px, auto); /* 行高 */
            gap: 5px; /* 间距 */
            margin: 10px 0;
        }

        .tab {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            text-align: center;
            font-size: 16px;
        }

        /* 响应式适配 */
        @media (max-width: 540px) {
            .tabs {
                grid-template-columns: repeat(4, minmax(60px,130px));
            }

            .tab {
                font-size: 16px;
                padding: 5px;
            }
        }

        .active-tab {
            background-color: #f0f0f0;
        }

        .clickable {
            cursor: pointer;
        }

        .click-effects-container {
            position: relative;
            bottom: -50%;
            left: 30%;
            right: 0;
            pointer-events: none;
        }

        .click-effect {
            position: absolute;
            font-size: 16px;
            color: #114514;
            font-weight: bold;
            animation: floatUp 2s ease-out forwards;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        @keyframes floatUp {
            0% {
                transform: translateY(0);
                opacity: 1;
            }

            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

/* 响应式调整 */
        @media (max-width: 540px) {
            .big-pei {
                font-size: 80px;
            }

            .click-effect {
                font-size: 18px;
            }
        }

        .golden-pei {
            width: 50px;
            height: 50px;
            background-color: gold;
        }

        .golden-pei-hide {
            width: 50px;
            height: 50px;
            background-color: #cccccc;
        }

        .effect-toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #ff9800;
            animation: slideIn 0.3s ease-out;
        }

        .disabled {
            background-color: #ccc;
        }

        .divider {
            line-height:0px;
            color:white;
        }

        .building-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, 1fr);
        }

        .building {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* 添加这行 */
            background: #f8f8f8;
        }

        .bulk-selector {
            margin: 10px 0;
            padding: 5px;
            background: #f0f0f0;
        }

        .upgrade-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, 1fr);
        }

        .upgrade {
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between; /* 添加这行 */
            background: #f8f8f8;
        }

        .achievement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, 1fr);
        }

        .achievement {
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f8f8f8;
        }

            .achievement.unlocked {
                border-color: #4CAF50;
                background: #e8f5e9;
            }

        .achievement-icon {
            font-size: 2em;
            margin-right: 15px;
        }

        .achievement-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .achievement-info p {
            margin: 0;
            color: #666;
        }

        .achievement-info small {
            color: #999;
            font-size: 0.8em;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        .achievement-toast {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideIn 0.3s ease-out;
            border-left: 5px solid #4CAF50;
        }

        .shop {
            margin-top: 20px;
            border-top: 2px solid #666;
            padding-top: 15px;
        }

        .upgrade-item {
            border: 2px solid #aaa;
            padding: 10px;
            border-radius: 5px;
            background: rgba(248,248,248,0.2);
        }

            .upgrade-item button {
                margin: 5px 0;
            }

            .upgrade-item.unlocked {
                border-color: #4CAF50;
                background: rgba(200,255,200,0.2);
            }

                /* 进度条现代样式 */
.progress-bar {
  height: 16px;
  background: #f0f0f0;
  border-radius: 8px;
  overflow: hidden;
  box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
  margin: 8px;
}
.progress-bar > div {
  height: 100%;
  background: linear-gradient(90deg, #4CAF50 0%, #81C784 100%);
  border-radius: 8px;
}

/* 佩干生命卡片样式 */
.pei-life {
  background: white;
  border:#dfbf0d solid 2px;
  border-radius: 8px;
  padding: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  transition: transform 0.2s, box-shadow 0.2s;
}

        .space {
            background-color: #001c60;
            color:#FFE29F
        }

        .offline-toast {
            position: fixed;
            right: 20px;
            bottom: 80px;
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            border-left: 5px solid #2196F3;
            animation: slideIn 0.3s ease-out;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header-fixed" v-if="currentArea==1">
            <div class="header-text" style="font-size: 32px;">你有 {{ format(peiCount) }} 佩干</div>
            <div class="header-text" style="font-size: 20px;">{{ format(peiPerSecond) }}/秒</div>
            <div class="header-text" style="font-size: 20px;">{{ format(peiPerClick) }}/点击</div>
        </div>
        <div class="header-fixed" v-if="currentArea==2">
            <div class="header-text" style="font-size: 32px;">你有 {{ format(fosskie) }} 化石饼干</div>
            <div class="header-text" style="font-size: 20px;">{{ format(fosskiePerSecond) }}/秒</div>
            <div class="header-text" style="font-size: 20px;">{{ format(fosskiePerClick) }}/点击</div>
        </div>

        <div class="clickable" @click="clickPei" style="width: 200px; height: 200px; background-image: url('pelkie.bmp')">
            <div class="click-effects-container">
                <div v-for="(effect, index) in clickEffects"
                     :key="index"
                     :style="effect.style"
                     class="click-effect">
                    +{{ format(effect.amount) }}
                </div>
            </div>
        </div>

        <div :class="goldenPeiVisible?'golden-pei clickable':'golden-pei-hide'" @click="clickGoldenPei" style="font-size:36px; text-align:center">♅</div>

        <div class="bonus-status">
            <div title="每1个成就获得1(基础值)牛奶，购买对应升级后，基于牛奶数量提高佩干产量乘数">牛奶: {{ format(milk) }}</div>
            <div title="每3600秒产生1(基础值)糖块，每个糖块+0.1%佩干产量，购买对应升级后，基于糖块数量提高佩干产量乘数">糖块: {{ format(sugar) }} {{this.sugar.gte(1000)&this.breakCount.lt(1)?"(已达上限)":""}}</div>
        </div>

        <div title="每420秒上方的♅区域会变成金色，点击♅后会随机获得一个新的效果">金佩勒效果: <span id="effectSpan"></span></div>

        <div class="tabs">
            <div v-for="(tab, index) in tabs" :key="index"
                 v-show="showTab(index)"
                 class="tab clickable"
                 :class="{ 'active-tab': currentTab === index }"
                 @click="currentTab = index">
                {{ tab }}
            </div>
        </div>

        <!-- 建筑选项卡 -->
        <div v-if="currentTab === 0">
            <div class="bulk-selector">
                购买数量:
                <select v-model="bulkAmount">
                    <option value="1">×1</option>
                    <option value="10">×10</option>
                    <option value="100">×100</option>
                    <option value="1000">×1000</option>
                    <option value="10000">×10000</option>
                    <option value="100000">×100000</option>
                    <option value="1000000">×1000000</option>
                </select>
                <button @click="buyAllBuilding" v-show="ascensionCount.gte(1)">一键购买</button>
            </div>
            <div class="building-grid">
                <div class="divider">----------------------------------------------------------------</div>
                <div v-for="(building, index) in buildings" :key="index" class="building">
                    &nbsp;&nbsp;建筑{{ building.id + 1 }}&nbsp;&nbsp;<br />
                    &nbsp;&nbsp;数量:{{ formatInt(building.quantity) }}&nbsp;&nbsp;<br />
                    &nbsp;&nbsp;基础佩干/秒:{{ format(building.baseProd) }}&nbsp;&nbsp;<br />
                    &nbsp;&nbsp;佩干/秒:{{ format(building.production) }}&nbsp;&nbsp;
                    <button @click="buyBuilding(index)"
                            :disabled="peiCount.lt(calcBulkCost(index))">
                        购买 ×{{ bulkAmount }}<br />
                        花费 {{ format(calcBulkCost(index)) }} 佩干
                    </button>
                </div>
            </div>
        </div>

        <!-- 升级选项卡 -->
        <div v-if="currentTab === 1">
            <div style="font-size:24px">升级 ({{ unlockedUpgradesCount }}/{{ upgrades.length }})</div>
            <div class="bulk-selector">
                <button @click="upgShowType = 1">显示未购买</button>
                <button @click="upgShowType = 2">显示已购买</button>
                <button @click="buyAllUpgrades" v-show="ascensionCount.gte(1)">一键购买</button>
            </div>
            <div class="upgrade-grid">
                <div class="divider">----------------------------------------------------------------</div>
                <div v-for="upgrade in upgrades"
                     :key="upgrade.buildingId*100+upgrade.id"
                     v-if="showUpgrade(upgrade)"
                     class="upgrade">
                    <div>
                        升级{{ upgrade.buildingId }}-{{ upgrade.id }}
                        <span v-if="upgrade.buildingId==1 & upgrade.id<4">点击和建筑 1 生产的佩干×2 </span>
                        <span v-if="upgrade.buildingId==1 & upgrade.id==4">每个建筑 2~42 使点击和建筑 1 生产的佩干 +1 </span>
                        <span v-if="upgrade.buildingId==1 & upgrade.id>4 & upgrade.id<=20">升级 1-4 的效果 ×20 </span>
                        <span v-if="upgrade.buildingId<100 & upgrade.buildingId>1 & upgrade.id<=20">建筑 {{upgrade.buildingId}} 的产量 ×2 </span>
                        <span v-if="upgrade.buildingId<100 & upgrade.id>20">建筑 {{upgrade.buildingId}} 的产量 ×{{format(Decimal.pow(buildings[upgrade.buildingId-1].baseCost,0.1).mul(upgrade.buildingId==1?1:1e6))}}，从 {{(upgrade.id-20)*(upgrade.id-20)*2000}} 个建筑 {{upgrade.buildingId}} 开始，每个建筑 {{upgrade.buildingId}} 使它的产量 ×{{Math.pow(2,0.02).toFixed(6)}} </span>   
                        <span v-if="upgrade.buildingId==101">点击获得的佩干 +1% <del>每秒生产的佩干</del></span>
                        <span v-if="upgrade.buildingId==102">释放牛奶力量(叠乘)，佩干产量 ×(1+牛奶*{{milkUpgradeBase[upgrade.id-1]*0.001.toFixed(3)}})</span>
                        <span v-if="upgrade.buildingId==103">建筑 2 的产量 ×2, 建筑 {{upgrade.id+2}} 的产量 +1% 每拥有 {{upgrade.id}} 个建筑 2 </span>
                        <span v-if="upgrade.buildingId==104 & upgrade.id<6">每个累计的飞升点使佩干产量 +{{Math.max(5,upgrade.id*25-25)}}%</span>
                        <span v-if="upgrade.buildingId==104 & upgrade.id>=6">佩干产量乘数 +{{Math.pow(10,upgrade.id-6)}}%</span>
                        <span v-if="upgrade.buildingId==105">佩干产量乘数 +{{Math.floor((upgrade.id-1)/10)+1}}%</span>
                        <span v-if="upgrade.buildingId==106">佩干产量乘数 +10% (需要每个建筑数量{{upgrade.required}})</span>
                        <span v-if="upgrade.buildingId==107 & upgrade.id==1">金佩勒出现频率翻倍，在屏幕上的持续时间翻倍</span>
                        <span v-if="upgrade.buildingId==107 & upgrade.id==2"><del>金佩勒出现频率翻倍，在屏幕上的持续时间翻倍</del>(被佩勒删除)</span>
                        <span v-if="upgrade.buildingId==107 & upgrade.id==3"><del>金佩勒效果的持续时间翻倍</del>(被佩勒删除)</span>
                        <span v-if="upgrade.buildingId==108">每个建筑 {{upgrade.id+1}} 增加 1% 建筑 {{upgrade.id+2}} 的产量，每个建筑 {{upgrade.id+2}} 增加 0.1% 建筑 {{(upgrade.id)%40+3}} 的产量</span>
                        <span v-if="upgrade.buildingId==109">每个建筑 {{upgrade.id}} 增加 1% 建筑 {{upgrade.id+2}} 的产量，每个建筑 {{upgrade.id+2}} 增加 0.1% 建筑 {{(upgrade.id+1)%40+3}} 的产量</span>
                        <span v-if="upgrade.buildingId==110">释放糖块力量(叠乘)，佩干产量 ×(1+糖块*{{milkUpgradeBase[upgrade.id-1]*0.001.toFixed(3)}})</span>
                    </div>
                    <button @click="buyUpgrade(upgrade.id, upgrade.buildingId)"
                            :disabled="!canBuyUpgrade(upgrade)">
                        {{ format(upgrade.cost.mul(upgradeCostMult)) }} 佩干
                    </button>
                </div>
            </div>
        </div>

        <!-- 成就选项卡 -->
        <div v-if="currentTab === 2">
            <div style="font-size:24px">成就 ({{ unlockedAchievementsCount }}/{{ achievements.length }})</div>
            <div class="bulk-selector">
                <button @click="achShowType = 1">显示全部</button>
                <button @click="achShowType = 2">显示已完成</button>
                <button @click="achShowType = 3">显示未完成</button>
            </div>
            <div class="achievement-grid">
                <div class="divider">----------------------------------------------------------------</div>
                <div v-for="achievement in achievements" 
                :key="achievement.buildingId*100+achievement.id" 
                class="achievement" :class="{ 'unlocked': achievement.unlocked }"
                v-if="achShowType==1 || (achShowType==2 && achievement.unlocked) || (achShowType==3 && !achievement.unlocked)">
                    <div class="achievement-info">
                        {{ achievement.unlocked ? '√' : '×' }} 成就{{ achievement.buildingId }}-{{ achievement.id }}
                        <span v-if="achievement.buildingId<100">拥有 {{formatInt(achievement.required)}} 个建筑 {{achievement.buildingId}}</span>
                        <span v-if="achievement.buildingId==101">累计获得 {{format(achievement.required)}} 个佩干</span>
                        <span v-if="achievement.buildingId==102">每秒生产 {{format(achievement.required)}} 个佩干</span>
                        <span v-if="achievement.buildingId==103">点击获得 {{format(achievement.required)}} 个佩干</span>
                        <span v-if="achievement.buildingId==104">累计获得 {{format(achievement.required)}} 个飞升点</span>
                        <span v-if="achievement.buildingId==105">累计获得 {{format(achievement.required)}} 个轮回点</span>
                        <span v-if="achievement.buildingId==106">累计获得 {{format(achievement.required)}} 个觉醒点</span>
                    </div>
                </div>
            </div>
        </div>

        <!--传送门选项卡-->
        <div v-if="currentTab === 3">
            <div class="divider">----------------------------------------------------------------</div>
            <div>点击传送进入其他区域，区域中的选项卡将发生变化，但不会重置任何资源</div>
            <div class="upgrade-item">
                佩干宇宙 - {{format(peiCount)}}佩干 {{currentArea==1?"（当前区域）":""}}
                <button @click="currentArea = 1" :disabled="currentArea==1">
                    传送
                </button>
            </div>
            <div class="upgrade-item">
                中生代山谷 - {{format(fosskie)}}化石饼干 {{currentArea==2?"（当前区域）":""}}
                <button @click="currentArea = 2" :disabled="currentArea==2" v-if="this.hypercendU[2].level.gte(1) || this.spaceResetCount.gte(1)">
                    传送
                </button>
                <span v-else>（需要觉醒升级3，1e12觉醒点）</span>
            </div>
            <div class="upgrade-item">
                超越（需要1e24焦糖）（敬请期待）

            </div>
            <div class="upgrade-item">
                探索中心（需要1e36黄油）（敬请期待）

            </div>
            <div class="upgrade-item">
                太空(需要觉醒升级5) {{currentArea==3?"（当前区域）":""}}
                <button @click="currentArea = 3" :disabled="currentArea==3" v-if="this.hypercendU[5].level.gte(1) || this.spaceResetCount.gte(1)">
                    传送
                </button>
            </div>
        </div>

        <!-- 飞升选项卡 -->
        <div v-if="currentTab === 4">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if="canAscend">
                <p>飞升将重置佩干、建筑和升级，获取 {{ format(this.totalShards.sub(this.totalRealityShards).max(0)) }} 飞升点 (下一个在 {{format(nextShards)}} 佩干)</p>
                <button @click="ascend" style="padding:5px 20px" :disabled="this.totalShards.sub(this.totalRealityShards).lte(0)">飞升!</button>
            </div>
            <div v-else>
                <p>飞升(ascend)需要 1e12 累计佩干 ({{ format(totalLifetimePei) }}/1e12)</p>
            </div>
            <div v-if="this.ascensionCount.gte(1)" class="shop">
                <h4>飞升升级 (你有 {{ format(realityShards) }}/{{format(totalRealityShards)}} 飞升点)</h4>
                <div class="bulk-selector">
                    <button @click="buyAllAscendU" v-show="ascensionCount.gte(1)">一键购买</button>
                    <button @click="refundAscendU">回退</button>
                </div>
                <div v-for="upgrade in ascendU" :key="upgrade.id" class="upgrade-item">
                    {{auDescription[upgrade.id-1]}}<br />
                    等级 {{ formatInt(upgrade.level) }}/{{ formatInt(upgrade.maxLevel) }}
                    <button @click="buyAscendU(upgrade.id-1)"
                            :disabled="realityShards.lt(upgrade.cost) || upgrade.level.gte(upgrade.maxLevel)">
                        {{ format(upgrade.cost) }} 飞升点
                    </button>
                    <button v-show="ascendU[8].level.gte(1) & upgrade.id==9" @click="switchGolden">
                        金佩勒：{{enableGolden?"启用":"禁用"}}
                    </button>
                    <button v-show="ascendU[16].level.gte(1) & upgrade.id==17" @click="switchClick">
                        点击：{{enableClick?"启用":"禁用"}}
                    </button>
                </div>
            </div>
            <div v-else class="shop">
                <p>飞升一次以解锁</p>
            </div>
        </div>

        <!-- 轮回选项卡 -->
        <div v-if="currentTab === 5">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if="canTranscend">
                <p>轮回将重置佩干、建筑、升级、飞升点和飞升升级，获取 {{ format(this.totalTP.sub(this.totalTranscendPoints).max(0)) }} 轮回点(下一个在 {{format(nextTP)}} 飞升点)</p>
                <button @click="transcend" style="padding:5px 20px" :disabled="this.totalTP.sub(this.totalTranscendPoints).lte(0)">轮回!</button>
            </div>
            <div v-else>
                <p>轮回(transcend)需要 1e12 累计飞升点 ({{ format(totalRealityShards) }}/1e12)</p>
            </div>
            <div v-if="this.transcensionCount.gte(1)" class="shop">
                <div>你的总计轮回点数使佩干产量乘以{{format(transcendBonus)}}</div>
                <h4>轮回神器 (你有{{ format(transcendPoints) }}/{{ format(totalTranscendPoints) }} 轮回点)</h4>
                <div class="bulk-selector">
                    <button @click="buyAllTranscendU" v-show="breakCount.gte(1)">一键购买</button>
                    <button @click="refundTranscendU">回退</button>
                </div>
                <div v-for="upgrade in transcendU" :key="upgrade.id" class="upgrade-item" v-if="upgrade.id<=12">
                    {{tuDescription[upgrade.id-1]}}<br />
                    等级 {{ formatInt(upgrade.level) }}
                    <button @click="buyTranscendU(upgrade.id-1)" 
                            :disabled="transcendPoints.lt(upgrade.cost)">
                        {{ format(upgrade.cost) }} 轮回点
                    </button>
                </div>
                <p>普通轮回升级</p>
                <div v-for="upgrade in transcendU" :key="upgrade.id" class="upgrade-item" v-if="upgrade.id>=13">
                    {{tuDescription[upgrade.id-1]}}<br />
                    等级 {{ formatInt(upgrade.level) }}/{{upgrade.maxLevel}}
                    <button @click="buyTranscendU(upgrade.id-1)" 
                            :disabled="transcendPoints.lt(upgrade.cost) | upgrade.level.gte(upgrade.maxLevel)">
                        {{ format(upgrade.cost) }} 轮回点
                    </button>
                </div>
            </div>
            <div v-else class="shop">
                <p>轮回一次以解锁</p>
            </div>
        </div>

        <!-- 破碎选项卡 -->
        <div v-if="currentTab === 6">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if=canBreak>
                <p>破碎将重置佩干、建筑、升级、飞升点、飞升升级、轮回点、轮回神器和升级，增加1次破碎次数</p>
                <button @click="doBreak" style="padding:5px 20px">破碎!</button>
            </div>
            <div v-else>
                <p>破碎(break)需要 {{format(nextBreak)}} 累计轮回点 ({{ format(totalTranscendPoints) }}/{{format(nextBreak)}})</p>
            </div>
            <div v-if="this.breakCount.gte(1)" class="shop">
                <h4>破碎里程碑 (你破碎了{{ format(this.breakCount) }}次)</h4>
                <div v-for="i in 16" class="upgrade-item" :class="{ 'unlocked': breakCount.gte(i<=8?i:i<=12?i*5-30:i*200-2200) }">
                    破碎{{i<=8?i:i<=12?i*5-30:i*200-2200}}次<br />
                    {{bmDescription[i-1]}}
                </div>
            </div>
            <div v-else class="shop">
                <p>破碎一次以解锁</p>
            </div>
        </div>

        <!-- 觉醒选项卡 -->
        <div v-if="currentTab === 7">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if="canHypercend">
                <p>觉醒将重置破碎重置的内容（但保留破碎次数），获取 {{format(this.HPGain)}} 觉醒点</p>
                <button @click="hypercend" style="padding:5px 20px">觉醒!</button>
            </div>
            <div v-else>
                <p>觉醒(hypercend)需要 8 次破碎 ({{ formatInt(breakCount) }}/8) 和 1e308 佩干 ({{ format(totalLifetimePei) }}/1e308)</p>
            </div>
            <div v-if="this.hypercendCount.gte(1)" class="shop">
                <div>
                    你有{{format(this.hypercendPoints)}}觉醒点，{{format(this.totalHypercendPoints)}}累计觉醒点，{{format(this.maxHypercendPoints)}}最高觉醒点
                </div>
                <h4>觉醒升级</h4> 
                <div v-for="upgrade in hypercendU" :key="upgrade.id" class="upgrade-item">
                    {{huDescription[upgrade.id-1]}}<br />
                    等级 {{ formatInt(upgrade.level) }}/{{ upgrade.maxLevel }}
                    <button @click="buyHypercendU(upgrade.id-1)"
                            :disabled="hypercendPoints.lt(upgrade.cost) | upgrade.level.gte(upgrade.maxLevel)">
                        {{ format(upgrade.cost) }} 觉醒点
                    </button>
                    <button @click="buyMaxHypercendU(upgrade.id-1)">
                        购买最大
                    </button>
                </div>
            </div>
            <div v-else class="shop">
                <p>觉醒一次以解锁</p>
            </div>
        </div>

        <!-- 自动化选项卡 -->
        <div v-if="currentTab === 8">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-for="upgrade in automation" :key="upgrade.id" class="upgrade-item" v-if="upgrade.id<=9 | hypercendU[4].level.gte(1)">
                {{autoDescription[upgrade.id-1]}}<br />
                <button @click="buyAuto(upgrade.id-1)" :disabled="upgrade.unlocked">
                    解锁需要 {{format(upgrade.cost)}} 佩干
                </button>
                <button @click="toggleAuto(upgrade.id-1)" :disabled="!upgrade.unlocked">
                    {{upgrade.activate?"开启":"关闭"}}
                </button>
            </div>
        </div>

        <!-- 充能选项卡 -->
        <div v-if="currentTab === 9">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if="hypercendU[0].level.gte(1)">
                你有 {{format(hyperCharge)}} 觉醒充能 (+{{format(HCProduction)}}/s)，它将你的佩干产量提高 {{format(hyperEffect(0))}} 倍。<br />
                <h4>觉醒神器</h4>
                <div v-for="upgrade in hyperChargeU" :key="upgrade.id" class="upgrade-item">
                    觉醒神器{{upgrade.id}}：{{hcDescription[upgrade.id-1]}}<br />
                    当前效果：×{{format(hyperEffect(upgrade.id))}}<br />
                    <button @click="buyHyperChargeU(upgrade.id-1)" 
                            :disabled="hypercendPoints.lt(upgrade.cost)">
                        {{upgrade.unlocked?"已解锁":"解锁需要"+format(upgrade.cost)+"觉醒点"}}
                    </button>
                </div>
            </div>
            <div v-else>
                需要购买觉醒升级1
            </div>
        </div>

        <!-- 统计选项卡 -->
        <div v-if="currentTab === 10">
            <h3>统计:</h3>
            <div>当前佩干: {{format(peiCount)}}</div>
            <div>本次飞升中的佩干: {{format(thisAscendPei)}}</div>
            <div>累计佩干: {{format(totalLifetimePei)}}</div>
            <div>佩干每秒: {{format(peiPerSecond)}}</div>
            <div>点击获得的佩干: {{format(totalClickPei)}}</div>
            <div>佩干每次点击: {{format(peiPerClick)}}</div>
            <div>金佩勒点击数: {{goldenPeiClick}}</div>

            <div>飞升次数: {{format(ascensionCount)}}</div>
            <div>当前飞升点: {{format(realityShards)}}</div>
            <div>累计飞升点: {{format(totalRealityShards)}}</div>

            <div>轮回次数: {{format(transcensionCount)}}</div>
            <div>当前轮回点: {{format(transcendPoints)}}</div>
            <div>累计轮回点: {{format(totalTranscendPoints)}}</div>

            <div>觉醒次数: {{format(hypercendCount)}}</div>
            <div>当前觉醒点: {{format(hypercendPoints)}}</div>
            <div>累计觉醒点: {{format(totalHypercendPoints)}}</div>

            <div>金佩勒计时：{{Math.floor(this.goldenPeiTimer)}}/{{this.goldenPeiTimeCap.toFixed(0)}}</div>
            <div>糖块计时: {{ Math.floor(playTime) }}/{{this.sugarTimeCap.toFixed(0)}}</div>
            <div>牛奶乘数: x{{ format(milkBonus) }}</div>
            <div>糖块乘数: x{{ format(sugarBonus) }}</div>
            <div>升级乘数: x{{ format(upgradeBonus) }}</div>
            <div>飞升乘数: x{{ format(ascendBonus) }}</div>
            <div>轮回乘数: x{{ format(transcendBonus) }}</div>
            <div>破碎乘数: x{{ format(breakBonus) }}</div>
            <!-- 原有统计信息... -->
        </div>

        <!-- 杂项选项卡 -->
        <div v-if="currentTab === 11">
            <button @click="saveGame()">导出</button>
            <button @click="loadGame()">导入</button>
            <button @click="hardReset()" style="color:red">硬重置</button>
            <div>
                佩乐点点勒（pelkie clicker）-v0.3.6-作者：6左爷6<br />
                （又叫做cookie clicker NG+3）<br />
                本游戏参考了《饼干点点乐》、《王朝之系谱》、《从细胞到奇点》、《真实割草增量》，<del>你可以点击链接游玩它们</del><br />
                后续可能的更新：太空（第4层重置，获得香料/坚果）、暗物质（第5层重置）
                副本1（中生代山谷，它的等级增加糖块加成）、糖粉化（副本1第1层重置）、糖浆化（1-2）、果糕/焦糖化（1-3）、
                副本2（超越，它的等级增加牛奶加成）、炼乳化（2-1）、奶油化（2-2）、拜谢/黄油化（2-3）、
                副本3（探索中心）、……等等
                最终目标：到达1e9,000,000,000,000,000佩干并打败佩勒<br />
                Pelle毁灭了你的饼干宇宙，把你的饼干变成了佩勒饼干，你无法逃离被毁灭的饼干宇宙，你在整个游戏中都会受到重大削弱。<br />
                削弱:<br />
                风味饼干升级被删除（天堂升级和建筑数量相关的除外）<br />
                删除研究中心<br />
                删除老奶奶末世<br />
                删除季节<br />
                删除小游戏<br />
                协同升级效果被修改<br />
                无法用糖块升级建筑<br />
                移除了一些飞升升级<br />
                移除了一些成就<br />
                金饼干效果中的"7"变成"6"<br />
                升级和效果中的一些文字被删除<br />
                天堂碎片在1e12后公式变为饼干^1/4<br />
                增强:<br />
                声望等级效果x100<br />
                糖块生长速度×24<br />
                新增22个建筑<br />
                一开始就有6小时80%的离线收益<br />
                新声望层级:轮回,在1e48累计饼干后解锁<br />
                新声望层级:破碎/觉醒,在1e192/1e308累计饼干后解锁<br />
            </div>
        </div>

        <div v-if="currentTab === 12">
            <div>
                解锁了中生代山谷…… 
                佩勒：为了实现你的 [命运/使命/目标]，我们为什么不回忆一下呢？
                毕竟，你一定喜欢 [错误/上帝/毁灭者] 荣耀的故事。<br />
                你发现了一个奇怪的骨骼化石，现在我需要您模拟一个活体标本进行研究，
                这些生物曾经是地球上的主要生命形式，也许可以了解它们是如何走向灭亡的。
                您可以通过传送随时返回到主界面（佩干宇宙）。 <br />
                基于化石饼干总数，获得对所有糖块升级的加成（×(1+化石饼干/1e4)^0.25）<br />
                <br />
                到达1e12化石饼干后解锁“糖霜”重置，重置所有佩干生命，用糖霜升级一星特征<br />
                到达1e48化石饼干后解锁“蜂蜜”重置，重置所有佩干生命和一星特征，用蜂蜜升级二星特征<br />
                到达1e192化石饼干后可以变甜，重置所有佩干生命、一星、二星特征，基于变甜次数获得奖励<br />
                变甜8次且到达1e308化石饼干后，解锁“焦糖”重置，重置变甜重置的内容，用焦糖升级三星特征<br />
                <br />
                化石饼干：{{format(fosskie)}}<br />
                化石饼干总数：{{format(totalFosskie)}}<br />
                本次重置中的化石饼干：{{format(resetFosskie)}}<br />
                糖霜数量：{{format(icing)}}<br />
                总计糖霜数量：{{format(totalIcing)}}<br />
                蜂蜜数量：{{format(honey)}}<br />
                总计蜂蜜数量：{{format(totalHoney)}}<br />
            </div>
        </div>

        <!--中生代山谷选项卡-->
        <div v-if="currentTab === 13" class="building-grid">
            <div class="divider">----------------------------------------------------------------</div>
            <div>在中生代山谷中点击大佩干将获得化石饼干</div>
            <div>佩干生命每500级产量乘以1e20</div>
            <div>总计化石饼干数量：{{format(totalFosskie)}}</div>
            <div>它们将糖块升级效果乘以{{format(this.totalFosskie.add(1).pow(0.25))}}</div>
            <div class="bulk-selector">
                购买数量:
                <select v-model="bulkLifeAmount">
                    <option value="1">×1</option>
                    <option value="10">×10</option>
                    <option value="100">×100</option>
                    <option value="1000">×1000</option>
                </select>
            </div>
            <div v-for="(p, index) in peiLives" :key="index" class="pei-life">
                佩干生命{{ p.id }} - {{index%3==0?"草食":index%3==1?"肉食":"杂食"}}，{{index/3%3<1?"水生":index/3%3<2?"陆生":"两栖"}}，{{index/9%3<1?"小型":index/9%3<2?"中型":"大型"}} - {{p.progress.toFixed(1)}}/{{p.duration.toFixed(1)}}s<br />
                数量：{{p.level}} 基础产量：{{format(p.baseProd)}} 产量：{{format(calcLifeProd(index))}}<br />
                产量×{{format(calcLifeMult(index))}} 速度×{{format(calcSpeedMult(index))}} 价格÷{{format(calcCostMult(index))}}<br />
            <button @click="buyPeiLife(index, bulkLifeAmount)" :disabled="fosskie.lt(calcLifeBulkCost(index, bulkLifeAmount))">
                购买×{{bulkLifeAmount}}花费<br /> {{ format(calcLifeBulkCost(index, bulkLifeAmount)) }}
            </button>
            <button @click="unlockLifeAuto(index)" :disabled="p.level.lte(0) | fosskie.lt(p.baseCost.mul(10))">
                <div v-if="!p.auto">解锁自动生产<br />{{ format(p.baseCost.mul(10)) }}</div>
                <div v-else>已解锁<br />自动生产</div>
            </button>
            <button @click="startLifeProd(index)" :disabled="p.level.lte(0)">
                开始<br />生产
            </button>
            <div class="progress-bar">
                <div :style="{ width: p.progress/p.duration*100 + '%' }"></div>
            </div>
            </div>
        </div>

        <!--中生代山谷重置-->
        <div v-if="currentTab === 14">
            <div class="divider">----------------------------------------------------------------</div>
            <div v-if="resetFosskie.gte(1e12)">
                <p>糖霜重置将重置化石饼干和佩干生命（但保留自动生产）<br />获取 {{format(icingGain)}} 糖霜</p>
                <button @click="icingReset" style="padding:5px 20px">糖霜重置</button>
            </div>
            <div v-else>
                需要1e12本次重置中的化石饼干才能进行糖霜重置<br />
                {{format(resetFosskie)}}/1e12
            </div>
            <div v-if="resetFosskie.gte(1e48)" class="shop">
                <p>蜂蜜重置将重置化石饼干、佩干生命、糖霜、一星性状<br />获取 {{format(honeyGain)}} 蜂蜜</p>
                <button @click="honeyReset" style="padding:5px 20px">蜂蜜重置</button>
            </div>
            <div v-else class="shop">
                需要1e48本次重置中的化石饼干才能进行蜂蜜重置<br />
                {{format(resetFosskie)}}/1e48
            </div>
            <div class="shop">
                
            </div>
        </div>



        <div v-if="currentTab === 15">
            <div class="divider">----------------------------------------------------------------</div>
            <div>
                糖霜数量：{{format(icing)}}<br />
                蜂蜜数量：{{format(honey)}}<br />
                <p>一星性状（共27种） 糖霜重置一次后可购买</p>
                <div v-for="(t, index) in traits" :key="index" class="pei-life" v-if="index<27">
                    一星性状{{index+1}}: 每级将佩干生命{{index+1}}产量×2<br />
                    等级：{{t.level}}，效果：×{{format(Decimal.pow(2,t.level))}}<br />
                    <button @click="buyTrait(index)" :disabled="totalIcing.lte(0)">升级需要{{format(t.cost)}}糖霜</button>
                </div>
                <p>二星性状（共12种） 蜂蜜重置一次后可购买</p>
                <div v-for="(t, index) in traits" :key="index" class="pei-life" v-if="index>=27 & index<39">
                    二星性状{{index+1}}: 每级{{traitDescription[index-27]}}<br />
                    等级：{{t.level}}，效果：×{{index<36?format(Decimal.pow(2,t.level)):format(t.level.mul(0.2).add(1))}}<br />
                    <button @click="buyTrait(index)" :disabled="totalHoney.lte(0)">升级需要{{format(t.cost)}}蜂蜜</button>
                </div>
                <!--p>三星性状（共3种）</p>
                <div v-for="(t, index) in traits" :key="index" class="pei-life" v-if="index>=39 & index<42">
                    三星性状{{index+1}}: 每级将{{index==39?"所有佩干生命产量×2":index==40?"所有佩干生命速度×2":"所有佩干生命价格÷2"}}<br />
                    等级：{{t.level}}，效果：×{{format(Decimal.pow(2,t.level))}}<br />
                    <button @click="buyTrait(index)" disabled="caramel.lt(t.cost)">升级需要{{format(t.cost)}}焦糖</button>
                </div-->
            </div>
        </div>

        <div v-if="currentTab === 16">
            <div class="divider">----------------------------------------------------------------</div>
        </div>

        <div v-if="currentTab === 17">
            <div class="divider">----------------------------------------------------------------</div>
        </div>

        <div v-if="currentTab === 18" class="space">
            <div class="divider" style="color:#000080">----------------------------------------------------------------</div>
            您不满足于寻常世界的万物法则，将目光投向银河中未解的存在，并期待那些遥远的神秘能够满足自己的好奇心。<br />
            佩勒：无数维度、幽灵以及对量子世界的操控，将所有理想简化为无穷多的点，在无数领域进行实验，以及利用物质与反物质的湮灭。
            在这里？你把自己变成了八维生物，然后你在那里停得太久，以至于你周围形成了一片星云。<br />
            太空重置将重置佩干、升级、飞升、轮回、破碎、觉醒、糖块、化石饼干（但保留中生代山谷的其他内容），获得坚果，数量基于佩干总数和化石饼干总数
            (佩干^1/30000*log10(化石饼干)/300)
            <div class="space-reset-section">
                <h4>太空重置</h4>
                <p v-if="!canSpaceReset" class="reset-locked">需要 {{format(this.totalLifetimePei)}}/1e36525 佩干<br /> {{format(this.totalFosskie)}}/1e84 化石饼干</p>
                <div v-else class="reset-ready">
                    <p>当前可获得坚果: {{ format(nutGain) }}</p>
                    <button @click="spaceReset" class="space-reset-button">执行太空重置</button>
                </div>
            </div>
            <div class="upgrade-item" :class="{ 'unlocked': spaceResetCount.gte(1) }">
                 第1次太空重置<br />
                 每次太空重置保留1飞升点、1轮回点、1次破碎、1觉醒点，在所有重置中保留1e4建筑1和建筑2
            </div>
        </div>

        <div v-if="currentTab === 19" class="space">
            <div class="divider" style="color:#000080">----------------------------------------------------------------</div>
            <div class="space-upgrades-tree">
                <h3>太空升级树 ({{ format(nutCount) }} 坚果)</h3>
                <div class="upgrade-node">
                    <div class="upgrade-info">
                        <div>升级1 等级{{ getSpaceUpgrade(1).level }}/20</div>
                        <div>每级使化石饼干的产量×2</div>
                        <button @click="buySpaceUpgrade(1)">{{ format(getSpaceUpgrade(1).cost) }}坚果</button>
                    </div>
                    <div class="children-container">
                        <div class="upgrade-node" :class="{unlocked: getSpaceUpgrade(2).level.gte(1) || getSpaceUpgrade(1).level.gte(1)}">
                            <div class="upgrade-info">
                                <div>升级2 等级{{ getSpaceUpgrade(2).level }}/20</div>
                                <div>每级使觉醒点数获取×2</div>
                                <button @click="buySpaceUpgrade(2)">{{ format(getSpaceUpgrade(2).cost) }}坚果</button>
                            </div>
                        </div>
                        <div class="upgrade-node" :class="{unlocked: getSpaceUpgrade(3).level.gte(1) || getSpaceUpgrade(1).level.gte(1)}">
                            <div class="upgrade-info">
                                <div>升级3 等级{{ getSpaceUpgrade(3).level }}/20</div>
                                <div>每级使觉醒充能速度×10</div>
                                <button @click="buySpaceUpgrade(3)">{{ format(getSpaceUpgrade(3).cost) }}坚果</button>
                            </div> 
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        var formatsave = {
            encoder: new TextEncoder(),
            decoder: new TextDecoder(),
            startString: 'PelkieClickerSaveFormat',
            endString: 'EndOfSaveFile',
            steps: [{
                encode: JSON.stringify,
                decode: JSON.parse
            },
            {
                encode: x => formatsave.encoder.encode(x),
                decode: x => formatsave.decoder.decode(x)
            },
            {
                encode: x => pako.deflate(x),
                decode: x => pako.inflate(x)
            },
            {
                encode: x => Array.from(x).map(i => String.fromCharCode(i)).join(""),
                decode: x => Uint8Array.from(Array.from(x).map(i => i.charCodeAt(0)))
            },
            {
                encode: x => btoa(x),
                decode: x => atob(x)
            },
            {
                encode: x => x.replace(/=+$/g, "").replace(/0/g, "0a").replace(/\+/g, "0b").replace(/\//g, "0c"),
                decode: x => x.replace(/0b/g, "+").replace(/0c/g, "/").replace(/0a/g, "0")
            },
            {
                encode: x => formatsave.startString + x + formatsave.endString,
                decode: x => x.slice(formatsave.startString.length, -formatsave.endString.length),
            }
            ],
            encode(s) {
                return this.steps.reduce((x, f) => f.encode(x), s);
            },
            decode(s) {
                return this.steps.reduceRight((x, f) => f.decode(x), s);
            },
        }

        function transformToDecimal(object) {
            for (i in object) {
                if (typeof (object[i]) == 'string' && !isNaN(N(object[i]).m)) object[i] = N(object[i]);
                if (typeof (object[i]) == 'object') transformToDecimal(object[i]);
            }
        }

        function data_print() {
            localStorage.PelkieClickerSave = formatsave.encode(JSON.stringify(data));
        }

        function data_input() {
            if (!localStorage.PelkieClickerSave) return;
            if (localStorage.PelkieClickerSave[0] == 'e') data = JSON.parse(atob(localStorage.PelkieClickerSave));
            else data = JSON.parse(formatsave.decode(localStorage.PelkieClickerSave));
            transformToDecimal(data);
        }

        async function jtb(text) {
            try {
                await navigator.clipboard.writeText(text);
                console.log('Text copied to clipboard');
            } catch (err) {
                console.error('Failed to copy text: ', err);
            }
        }

        function export_save() {
            jtb(formatsave.encode(JSON.stringify(data)));
        }

        function import_save() {
            let userInput = prompt("导入：", "输入存档");
            if (userInput != null && userInput !== "") {
                if (userInput[0] == 'e') data = JSON.parse(atob(userInput));
                else data = JSON.parse(formatsave.decode(userInput));
                transformToDecimal(data);
                data_print();
                location.reload();
            } else {
            }
        }

        function N(num) {
            return new Decimal(num);
        }
        const UPGRADES = (() => {
            const upgrades = [];
            upgrades.push({
                id: 0,
                buildingId: 1,
                required: N(0),
                cost: N(40),
            })
            //升级1~1050:建筑乘数升级
            for (let i = 1; i <= 1050; i++) {
                let index = (i-1) % 25 + 1;
                let bIndex = Math.floor((i-1) / 25);
                let costMult = [10,50,500,50000,5e6,5e9,5e12,5e15,5e18,5e21,5e24,5e27,5e30,5e33,5e36,5e39,5e42,5e48,5e54,5e60,5e120,'5e360','5e720','5e1200','5e1800'];
                let requirement = [1,5,25,50,100,150,200,250,300,350,400,450,500,550,600,650,700,800,900,1000,2000,6000,12000,20000,30000];
                upgrades.push({
                    id: index,
                    buildingId: bIndex+1,
                    required: N(requirement[index-1]),
                    cost: N(costMult[index-1]).mul(Math.pow(10, bIndex * (bIndex - 1) / 40 + bIndex + 1)),
                })
            }
            //升级1051~1070:点击乘数
            for (let i = 1; i <= 20; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 101,
                    required: N(100).pow(i),
                    cost: N(100).pow(i).mul(5),
                })
            }
            //升级1071~1110:牛奶乘数
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 102,
                    required: i==1?N(10):N(25).mul(i-1),
                    cost: N(1000).pow(i).mul(9000),
                })
            }
            //升级1111~1150:建筑2协同
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 103,
                    required: N(15),
                    cost: N(Math.pow(10, i * (i - 1) / 40 + i + 1)).mul(150),
                })
            }
            //升级1151~1160:飞升效果
            for (let i = 1; i <= 10; i++) {
                let costs = [11, 1111, 111111, 11111111, 1111111111, 100, 1e12, 1e72, "1e432", "1e2592"];
                upgrades.push({
                    id: i,
                    buildingId: 104,
                    required: i,
                    cost: N(costs[i-1]),
                })
            }
            //升级1161~1250:飞升风味佩干
            for (let i = 1; i <= 90; i++) {
                let costs = [];
                upgrades.push({
                    id: i,
                    buildingId: 105,
                    required: N(Math.floor((i-1)/10)+1),
                    cost: i<=50?N(1e10).mul(N(10).pow(i/5)):N(100).pow(i),
                })
            }
            //升级1251~1290:建筑产量风味佩干
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 106,
                    required: i<=16?i*50+50:i*1000-16000,
                    cost: i<=16?N(1000).pow(i).mul(1e87):N(1e60).pow(i-16).mul(1e87),
                })
            }
            //升级1291~1299:金佩勒升级
            for (let i = 1; i <= 10; i++) {
                let requires = [7,27,77,9e15,9e15,9e15,9e15,9e15,9e15,9e15,]
                let costs = [777777777, 77777777777, 77777777777777, "7e1777", "7e2777", "7e3777", "7e4777", "7e5777", "7e6777", "7e7777"];
                upgrades.push({
                    id: i,
                    buildingId: 107,
                    required: N(requires[i-1]),
                    cost: N(costs[i-1]),
                })
            }
            //升级1300~1339:飞升团结I升级,需要15个建筑
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 108,
                    required: N(15),
                    cost: N(Math.pow(10, (i + 1) * i / 40 + i + 2)).mul(150),
                })
            }
            //升级1340~1379:飞升团结II升级,需要75个建筑
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 109,
                    required: N(75),
                    cost: N(Math.pow(10, (i + 1) * i / 40 + i + 2)).mul(5e5),
                })
            }
            //升级1380~1419:释放糖块力量升级
            for (let i = 1; i <= 40; i++) {
                upgrades.push({
                    id: i,
                    buildingId: 110,
                    required: N(Math.floor((i-1)/10)+1),
                    cost: N(1e10).pow(i).mul(8e90),
                })
            }
            //其他升级……
            return upgrades;
        })();
        const ACHIEVEMENTS = (() => {
            const achievements = [];
            //成就 :累计获得的佩干数量
            for (let i = 1; i <= 25; i++) {
                let targetT = i <= 16 ? N(100).pow(i) : N(10).pow(N(10).pow(i - 15));
                achievements.push({
                    id: i,
                    buildingId: 101,
                    required: targetT,
                })
            }
            //成就 :每秒获得的佩干数量
            for (let i = 1; i <= 25; i++) {
                let targetS = i <= 16 ? N(10).pow(i) : N(10).pow(N(10).pow(i - 15));
                achievements.push({
                    id: i,
                    buildingId: 102,
                    required: targetS,
                })
            }
            //成就 :点击获得的佩干数量
            for (let i = 1; i <= 25; i++) {
                let targetC = i <= 16 ? N(100).pow(i) : N(10).pow(N(10).pow(i - 15));
                achievements.push({
                    id: i,
                    buildingId: 103,
                    required: targetC,
                })
            }
            //成就 :拥有的建筑数量
            for (let i = 1; i <= 1050; i++) {
                let target = [1,50,100,150,200,250,300,350,400,450,500,600,700,800,900,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000];
                achievements.push({
                    id: (i  -1) % 25 + 1,
                    buildingId: Math.floor((i-1)/25) + 1,
                    required: N(target[(i - 1) % 25]),
                })
            }
            //成就 :飞升层级成就
            for (let i = 1; i <= 25; i++) {
                let target = i <= 10 ? N(10).pow(i-1) : N(1e10).pow(i-10);
                achievements.push({
                    id: i,
                    buildingId: 104,
                    required: target,
                })
            }
            //成就 :超越层级成就
            for (let i = 1; i <= 25; i++) {
                let target = i <= 10 ? N(10).pow(i-1) : N(1e10).pow(i-10);
                achievements.push({
                    id: i,
                    buildingId: 105,
                    required: target,
                })
            }
            //成就 :觉醒层级成就
            for (let i = 1; i <= 25; i++) {
                let target = i <= 10 ? N(10).pow(i-1) : N(1e10).pow(i-10);
                achievements.push({
                    id: i,
                    buildingId: 106,
                    required: target,
                })
            }
            //成就 :其他……
            return achievements;
        })();
        const ASCENDU = (() => {
            const ascendU = [];
            ascendU.push({ id: 1, cost: N(1), maxLevel: N(1) });//解锁飞升系统
            ascendU.push({ id: 2, cost: N(3), maxLevel: N(3) });//佩干产量乘数+10% 3,3e3,3e6
            ascendU.push({ id: 3, cost: N(5), maxLevel: N(5) });//解锁风味佩干 5+n*10
            ascendU.push({ id: 4, cost: N(7), maxLevel: N(7) });//离线时长 7^(n+1)
            ascendU.push({ id: 5, cost: N(50), maxLevel: N(2) });//初始拥有10建筑1或2 50*10^2n
            ascendU.push({ id: 6, cost: N(77), maxLevel: N(10) });//金佩干出现频率提升10% 77*10^2n
            ascendU.push({ id: 7, cost: N(100), maxLevel: N(5) });//背包 n*10^2n
            ascendU.push({ id: 8, cost: N(777), maxLevel: N(10) });//金佩干技能时间提升10% 777*10^2n
            ascendU.push({ id: 9, cost: N(999), maxLevel: N(6) });//禁用金佩干，pps+40+10等级% 999*10^3n
            ascendU.push({ id: 10, cost: N(9000), maxLevel: N(10) });//牛奶效果加成
            ascendU.push({ id: 11, cost: N(99999), maxLevel: N(10) });//建筑、升级价格降低2% 99999*10^5n
            ascendU.push({ id: 12, cost: N(222222), maxLevel: N(2) });//解锁协同升级，当拥有15和75个建筑时出现
            ascendU.push({ id: 13, cost: N(399999), maxLevel: N(1) });//升级价格除以5
            ascendU.push({ id: 14, cost: N(1.5e7), maxLevel: N(1) });//1-6到1-20的乘数变为1000
            ascendU.push({ id: 15, cost: N(1e8), maxLevel: N(10) });//糖块生长10%更快
            ascendU.push({ id: 16, cost: N(2e8), maxLevel: N(10) });//释放糖块力量
            ascendU.push({ id: 17, cost: N(1e9), maxLevel: N(6) });//禁用点击，pps+40+10等级% 10^(2n+9)
            ascendU.push({ id: 18, cost: N(2e9), maxLevel: N(1) });//建筑2升级变为x3.2
            ascendU.push({ id: 19, cost: N(9e9), maxLevel: N(5) });//每级每个牛奶升级增加建筑29%
            ascendU.push({ id: 20, cost: N(3.2e10), maxLevel: N(40) });//解锁不受束缚的升级
            return ascendU;
        })();
        const TRANSCENDU = (() =>{
            const transcendU = [];
            for(let i=1;i<=12;i++) transcendU.push({ id: i, cost: N(1), maxLevel: N(0)});
            transcendU.push({ id: 13, cost: N(10), maxLevel: N(1) });//轮回和飞升保留建筑
            transcendU.push({ id: 14, cost: N(100), maxLevel: N(1) });//禁用效果常时生效
            transcendU.push({ id: 15, cost: N(1000), maxLevel: N(1) });//金佩勒效果乘100
            transcendU.push({ id: 16, cost: N(10000), maxLevel: N(1) });//点击增加
            transcendU.push({ id: 17, cost: N(1e6), maxLevel: N(15) });//糖块生长增加20%
            transcendU.push({ id: 18, cost: N(1e6), maxLevel: N(15) });//金佩勒出现频率增加5%
            transcendU.push({ id: 19, cost: N(1e8), maxLevel: N(4) });//解锁更多风味佩干
            transcendU.push({ id: 20, cost: N(1e8), maxLevel: N(4) });//解锁糖块升级
            return transcendU;
        })();
        const HYPERCENDU = (() => {
            const hypercendU = [];
            hypercendU.push({ id: 1, cost: N(1), maxLevel: N(100) });//解锁觉醒充能，每级每秒获得1充能
            hypercendU.push({ id: 2, cost: N(1e6), maxLevel: N(100) });//解锁更多风味，充能率+49%每级
            hypercendU.push({ id: 3, cost: N(1e12), maxLevel: N(100) });//解锁更多风味，充能率+19%每级
            hypercendU.push({ id: 4, cost: N(1e24), maxLevel: N(100) });//解锁更多风味，充能率+9%每级
            hypercendU.push({ id: 5, cost: N(1e36), maxLevel: N(100) });//解锁更多风味，充能率+4%每级
            hypercendU.push({ id: 6, cost: N(1e60), maxLevel: N(100) });//解锁更多风味，充能率+1%每级
            return hypercendU;
        })();
        const HYPERCHARGEU = (() => {
            const hyperchargeU = [];
            const cost=[5,10,15,30,100,300,1500,6000,5e5,2e7,1e9,4e9,4e10,4e12,1e14,1e16];
            for(let i=0;i<16;i++) hyperchargeU.push({ id: i+1, cost:N(cost[i]), unlocked:false });//根据你的觉醒点数提升佩干获取和觉醒充能速度
            return hyperchargeU;
        })();
        const AUTOMATION = (() => {
            const automation = [];
            const cost=[1e5,1e10,2.5e25,7.7e77,1e20,1e40,1e80,1e160,"1e320","1e640","1e10000","1e14142","1e20000","1e28284"]
            for(let i=0;i<14;i++){
                automation.push({id:i+1, cost: N(cost[i]), unlocked:false, activate: false});//自动购买
            }
            return automation;
        })();
        const SPACEUPGRADES = (() => {
            const spaceU = [];
            for(let i=0;i<3;i++) spaceU.push({ id: i+1, cost: N(1), maxLevel: N(10) });
            return spaceU;
        })();

        const milkUpgradeBase=[4,5,6,7,8,8,8,8,
            8,7,6,5,4,4,4,4,
            1,1,1,1,1,2,2,2,
            2,2,3,3,3,3,3,5,
            5,5,6,6,6,7,7,7,
        ]
        new Vue({
            el: '#app',
            data: {
                lastUpdate: 0,
                backgroundDelta: 0,
                currentTab: 0,
                currentArea: 1,
                tabs: ['建筑', '升级', '成就', '传送', '飞升', '轮回', '破碎', '觉醒', '自动', '充能', '统计', '杂项', '简介', '生命', '声望', '性状', '变甜', '炼糖厂', '太空重置', '太空升级',],

                peiCount: N(0),
                thisAscendPei: N(0),
                totalLifetimePei: N(0),
                totalClickPei: N(0),
                peiPerSecond: N(0),
                peiPerClick: N(1),
                bulkAmount: 1,
                goldenPeiClick: 0,
                goldenPeiTimer: 0,
                goldenPeiVisible: false,
                goldenPeiEffects: {
                    clickMultiplier: N(1),
                    buildingMultiplier: N(1),
                    buildingCostReduction: N(1),
                    upgradeCostReduction: N(1),
                    randomBuildingBoost: null
                },
                effect: `无`,
                activeEffects: [],
                effectTimers: {},
                clickEffects: [],
                enableGolden: true,
                enableClick: true,
                upgShowType:1,
                achShowType:1,

                buildings: Array.from({ length: 42 }, (_, i) => ({
                    id: i,
                    quantity: N(0),
                    baseCost: N(10).pow(i * (i - 1) / 40 + i + 1),
                    cost: N(10).pow(i * (i - 1) / 40 + i + 1),
                    baseProd: N(8).pow(i - 1),
                    production: N(8).pow(i - 1),
                })),
                upgrades: UPGRADES.map(u => ({
                    ...u,
                    unlocked: false,
                })),
                achievements: ACHIEVEMENTS.map(a => ({
                    ...a,
                    unlocked: false,
                })),

                ascensionCount: N(0),
                realityShards: N(0),
                totalRealityShards: N(0),
                ascendU: ASCENDU.map(r => ({
                    ...r,
                    level: N(0),
                })),
                auDescription: [
                    "神啊！（解锁飞升系统和升级）",
                    "一个残余物（佩干产量乘数+10%）",
                    "佩勒的5个裂隙（每级解锁10种风味佩干升级，获得1e10佩干后出现）",
                    "6小时后更新（离线生产增加6小时）",
                    "飞升后保留10个前[该升级等级]种建筑",
                    "每级使金佩勒出现频率提升10%",
                    "飞升后保留前[该升级等级]个释放牛奶力量的升级",
                    "每级使金佩勒技能时间提升10%",
                    "可以选择禁用金佩勒，获得等级*10+40%佩干产量提升",
                    "释放牛奶力量(叠乘)，佩干产量×(1+0.001×等级×牛奶)",
                    "使建筑和升级的价格降低等级×2%",
                    "每级解锁40个协同升级，分别需要15和75个建筑3~42",
                    "升级的价格除以5",
                    "升级1-4的效果×25，点击产量×40",
                    "每级使糖块生长的速度增加20%",
                    "释放糖块力量(叠乘)，佩干产量×(1+0.001×(等级+1)×糖块)",
                    "可以选择禁用点击，获得等级*10+40%佩干产量提升",
                    "建筑2的×2升级效果变为×3.2",
                    "每级每个牛奶使建筑2产量增加0.2%",
                    "第n级该升级使建筑n+2的×2升级效果乘以1.05^(41-n)",
                ],
                
                transcensionCount: N(0),
                transcendPoints: N(0),
                totalTranscendPoints: N(0),
                transcendU: TRANSCENDU.map(r => ({
                    ...r,
                    level: N(0),
                })),
                
                tuDescription:[
                    "每级提升10%所有佩干获取（叠乘）",
                    "每级提升10%点击佩干获取（叠乘）",
                    "每级使建筑的价格减少1%（每级乘以0.99）",
                    "每级使升级的价格减少1%（每级乘以0.99）",
                    "每级使禁用金佩勒和点击的产量加成+10%",
                    "每级使金佩勒效果乘数+10%",
                    "每级使建筑1升级5~20的乘数+10%",
                    "每级使建筑2加成其他建筑的升级效果+10%",
                    "每级使释放糖块力量的效果+10%",
                    "每级使释放牛奶力量的效果+10%",
                    "每级使协同升级系列1(108-x)的效果+10%",
                    "每级使协同升级系列2(109-x)的效果+10%",
                    "每次轮回和飞升后保留100建筑1和建筑2",
                    "禁用金佩勒和点击的乘数变为常时生效",
                    "金佩勒获得饼干和随机建筑的效果乘以10",
                    "升级1-5至1-20的乘数乘以5",
                    "糖块的生长速度增加等级*20%，最高300%",
                    "金佩勒的出现频率增加等级*5%，最高75%",
                    "每级解锁10个新的风味饼干升级(在1e100~1e180佩干)",
                    "每级解锁10个释放糖块力量的普通升级",
                ],

                breakCount: N(0),

                bmDescription:[
                    "每次破碎使佩干产量×4，永久解锁自动化，每次飞升/轮回/破碎后保留1000建筑1和建筑2",
                    "糖块获取数量乘以破碎次数，最高乘以10(爆炸)",
                    "每个成就提供的牛奶翻倍(太爆炸了)",
                    "每破碎使建筑×2升级的基数加0.4，从4破碎开始8破碎结束",
                    "每破碎使轮回神器1和2的基数+2.5%，从5破碎开始8破碎结束",
                    "每次破碎对佩干产量的乘数翻倍，变为8",
                    "每次破碎对佩干产量的乘数翻倍，变为16",
                    "解锁觉醒重置，需要1e308佩干，飞升升级18的基数变为5",
                    "佩干产量乘以(累计觉醒点+4)，飞升升级20的基数变为1.1",
                    "每次破碎使觉醒点的获取数量+25%，从17破碎开始",
                    "每次破碎使觉醒充能翻倍，从25破碎开始44破碎结束",
                    "每次破碎使觉醒充能的奖励乘以1.25，从30破碎开始120破碎结束",
                    "每次破碎增加化石饼干产量1%",
                    "每次破碎增加佩干生命速度1%",
                    "每次破碎增加糖块出现频率0.1%",
                    "每1000次破碎使糖块获取数量+1",
                ],

                hypercendCount: N(0),
                hypercendPoints: N(0),
                totalHypercendPoints: N(0),
                maxHypercendPoints:N(0),
                hyperCharge: N(0),
                hypercendU: HYPERCENDU.map(r => ({
                    ...r,
                    level: N(0),
                })),

                huDescription:[
                    "解锁觉醒充能和觉醒神器（在充能选项卡中），每级该升级每秒产生1觉醒充能",
                    "购买建筑不再消耗佩干，觉醒充能速度+49%每级",
                    "解锁中生代山谷（在传送选项卡），觉醒充能速度+19%每级",
                    "使金佩勒效果持续时间变为永久，觉醒充能速度+9%每级",
                    "解锁更多自动化升级，觉醒充能速度+4%每级",
                    "解锁太空，下一阶的重置（还没出），觉醒充能速度+1%每级"
                ],

                hyperChargeU: HYPERCHARGEU.map(r => ({
                    ...r,
                    level: N(0),
                })),

                hcDescription:[
                    "基于累计觉醒点数增加觉醒充能速度",//5HP(hypercension point,觉醒点)
                    "基于最高觉醒点数增加神器1效果",//10
                    "基于当前觉醒点数增加神器2效果",//15
                    "基于当前轮回点数增加神器1/2/3效果",//30
                    "基于判定中的觉醒点数增加神器4效果",//100
                    "神器1效果再次乘以神器4的效果",//300
                    "基于最高觉醒点增加觉醒点乘数",//1500
                    "基于糖块数量，增加神器1/2/3/4/5的效果",//6000
                    "基于累计轮回点数增加觉醒充能速度",//5e5
                    "神器4和神器8的效果再生效一次",//2e7
                    "基于神器8的效果提升神器7的效果",//1e9
                    "基于累计轮回点提升神器1/2/3/4/5/8/9/11的效果",//4e9
                    "使神器12的效果对它自己生效",//4e10
                    "使神器12的效果乘以它的的1/3次方",//4e12
                    "使神器14的效果再生效一次，即变为乘以它的2/3次方",//1e14
                    "使神器14的效果再生效一次，即变为乘以它的1次方",//1e16
                    "根据盐块(月光石)的数量，提升神器1/2/3/4/5/8/9/11/12的效果",
                    "基于觉醒点数提升神器16的效果",
                    "基于  数量提升神器17的效果",
                    "神器16/17/18的效果^1.02",
                    "基于平衡数量提升神器16/17/18的效果",
                    "基于挑战完成数量提升神器16/17/18的效果",
                    "基于挑战点数提升神器16/17/18的效果",
                    "提升之前所有神器的效果(就是神器1乘数^1.5)",
                ],

                automation: AUTOMATION.map(a=>({
                    ...a,
                })),
                autoDescription:[
                    "自动购买建筑",
                    "自动购买升级",
                    "每0.1秒获得一次点击佩干收益",
                    "金佩勒出现时自动点击金佩勒",
                    "自动购买飞升升级",
                    "自动获得飞升点",
                    "自动购买轮回升级",
                    "自动获得轮回点",
                    "自动进行破碎，破碎不再重置任何东西",
                    "每秒自动生产0.1%判定中的觉醒点",
                    "自动购买佩干生命，它们不消耗化石饼干",
                    "自动购买一星性状，它们不消耗糖霜",
                    "每0.1秒获得一次点击化石饼干收益",
                    "自动购买二星性状，它们不消耗蜂蜜",
                    "每秒自动获得0.1%判定中的糖霜",
                    "每秒自动获得0.1%判定中的蜂蜜",
                    "自动购买觉醒升级和觉醒神器",
                    "自动进行变甜重置，变甜不再重置任何东西",
                    "自动购买三星性状，它们不消耗焦糖",
                    "每秒自动获得0.1%判定中的焦糖",
                ],

                nutCount: N(0),
                spaceResetCount: N(0),
                spaceRecord: N(0),
                spaceUpgrades: [
                    { id: 1, cost: N(1), level: N(0), maxLevel: N(10), children: [2,3] },
                    { id: 2, cost: N(1), level: N(0), maxLevel: N(10), children: [] },
                    { id: 3, cost: N(1), level: N(0), maxLevel: N(10), children: [] },
                ],

                unlockedMesval: false,
                fosskie: N(0),
                totalFosskie: N(0),
                resetFosskie: N(0),
                icing: N(0),
                totalIcing: N(0),
                honey:N(0),
                totalHoney:N(0),
                caramel:N(0),
                totalCaramel:N(0),

                bulkLifeAmount: 1,
                peiLives: Array(27).fill().map((_,i) => ({
                    id: i+1,
                    level: N(0),       // 当前等级
                    progress: 0,       // 生产进度(秒)
                    auto: false,       // 自动生产
                    timer: null,
                    duration: Math.pow(10, i/10+0.4),//生产所需时间(秒)
                    baseCost: N(12).pow(i+1),//基础成本
                    baseProd: N(8).pow(i+1)//基础产量
                })),
                traits: Array(42).fill().map((_,i) => ({
                    id: i+1,
                    tier: i<27?1:i<39?2:i<42?3:0,
                    level: N(0),
                    cost: N(1)
                })),
                traitDescription:[
                    "将草食生命产量×2",
                    "将肉食生命产量×2",
                    "将杂食生命产量×2",
                    "将水生生命速度×2",
                    "将陆生生命速度×2",
                    "将两栖生命速度×2",
                    "将小型生命价格÷2",
                    "将中型生命价格÷2",
                    "将大型生命价格÷2",
                    "将点击获得的化石饼干+20%",
                    "将糖块生长的速度+20%",
                    "将糖块升级的效果+20%",
                ],
                
                unlockedBeyond: false,
                starkie: N(0),
                totalStarkie: N(0),
                resetStarkie: N(0),
                cheese: N(0),
                totalCheese: N(0),
                cream: N(0),
                totalCream: N(0),
                butter: N(0),
                totalButter: N(0),

                unlockedExplor: false,
                logikie: N(0),

                milk: N(0),
                sugar: N(0),
                playTime: N(0),
                totalPlayTime: N(0),
                lastUpdateTime: Date.now(),
                // 其他数据...
            },
            methods: {
                showTab(i) {
                    if(this.currentArea == 1){
                        if(this.breakCount.lt(1)) return [0,1,2,4,5,6,10,11].includes(i);
                        else return [0,1,2,3,4,5,6,7,8,9,10,11].includes(i);
                    }
                    if(this.currentArea == 2) return[3,11,12,13,14,15].includes(i);
                    if(this.currentArea == 3) return[3,11,18,19].includes(i);
                },
                clickPei() {
                    if(this.currentArea==1){
                        if(!this.enableClick) return;
                        this.peiCount = this.peiCount.add(this.peiPerClick);
                        this.totalClickPei = this.totalClickPei.add(this.peiPerClick);
                        this.thisAscendPei = this.thisAscendPei.add(this.peiPerClick);
                        this.totalLifetimePei = this.totalLifetimePei.add(this.peiPerClick);
                        this.addClickEffect(this.peiPerClick);
                    }
                    else if(this.currentArea==2){
                        this.fosskie = this.fosskie.add(this.fosskiePerClick);
                        this.totalFosskie = this.totalFosskie.add(this.fosskiePerClick);
                        this.resetFosskie = this.resetFosskie.add(this.fosskiePerClick);
                        this.addClickEffect(this.fosskiePerClick);
                    }
                },
                addClickEffect(amount) {
                    const effect = {
                        amount: amount,
                        style: {
                            animationDuration: `2s`
                        }
                    };
                    this.clickEffects.push(effect);
                    // 2秒后移除效果
                    setTimeout(() => {
                        this.clickEffects = this.clickEffects.filter(e => e !== effect);
                    }, 2000);
                },
                switchClick() {
                    this.enableClick = !this.enableClick;
                },
                switchGolden(){
                    this.enableGolden = !this.enableGolden;
                },
                clickGoldenPei() {
                    if (!this.goldenPeiVisible || !this.enableGolden) return;
                    this.goldenPeiClick++;
                    const durationMult = this.ascendU[5].level.mul(0.1).add(1).toNumber();
                    const effectMult = this.transcendU[5].level.mul(0.1).add(1).toNumber();
                    const effectmult2 = this.transcendU[14].level.gte(1)?10:1;
                    const effects = [
                        {
                            name: '获得'+(15*effectMult*effectmult2).toFixed(1)+'<del>分钟</del>产量的佩干',
                            chance: 9,
                            apply: () => this.gainProduction(15*effectMult*effectmult2)
                        },
                        {
                            name: '获得的佩干×'+ (6*effectMult).toFixed(1) +'，持续'+ (66*durationMult).toFixed(1) +'秒',
                            chance: 6,
                            apply: () => this.applyBuildingMultiplier(6*effectMult, 66*durationMult)
                        },
                        {
                            name: '点击获得的佩干×'+(666*effectMult).toFixed(1)+'，持续'+(13*durationMult).toFixed(1)+'秒',
                            chance: 6,
                            apply: () => this.applyClickMultiplier(666*effectMult, 13*durationMult)
                        },
                        {
                            name: '随机建筑提升<del>佩干产量，基于该建筑数量×</del>'+(10*effectMult*effectmult2).toFixed(1)+'%，持续'+(30*durationMult).toFixed(1)+'秒',
                            chance: 4,
                            apply: () => this.boostRandomBuilding(1+0.1*effectMult*effectmult2, 30*durationMult)
                        },
                        {
                            name: '获得的佩干×'+(15*effectMult).toFixed(1)+'，持续'+(30*durationMult).toFixed(1)+'秒',
                            chance: 3,
                            apply: () => this.applyBuildingMultiplier(15*effectMult, 30*durationMult)
                        },
                        {
                            name: '点击获得的佩干×'+(1111*effectMult).toFixed(1)+'，持续'+(8*durationMult).toFixed(1)+'秒',
                            chance: 3,
                            apply: () => this.applyClickMultiplier(1111*effectMult, 8*durationMult)
                        },
                        {
                            name: '建筑价格-'+(100-50/effectMult).toFixed(1)+'%，持续'+(5*durationMult).toFixed(1)+'秒',
                            chance: 2,
                            apply: () => this.applyBuildingCostReduction(0.5/effectMult, 5*durationMult)
                        },
                        {
                            name: '升级价格-'+(100-50/effectMult).toFixed(1)+'%，持续'+(5*durationMult).toFixed(1)+'秒',
                            chance: 2,
                            apply: () => this.applyUpgradeCostReduction(0.5/effectMult, 5*durationMult)
                        },
                        {
                            name: '获得1个糖块',
                            chance: 1,
                            apply: () => this.gainCandy()
                        },
                    ];
                    const allEffects = [...effects];
                    const selectedEffect = this.selectRandomEffect(allEffects);
                    selectedEffect.apply();
                    this.goldenPeiVisible = false;
                    this.showEffectNotification(selectedEffect.name);
                },
                applyClickMultiplier(multiplier, duration) {
                    this.goldenPeiEffects.clickMultiplier = N(multiplier);
                    this.startEffectTimer('clickMultiplier', () => {
                        this.goldenPeiEffects.clickMultiplier = N(1);
                    }, duration * 1000);
                },
                applyBuildingMultiplier(multiplier, duration) {
                    this.goldenPeiEffects.buildingMultiplier = N(multiplier);
                    this.startEffectTimer('buildingMultiplier', () => {
                        this.goldenPeiEffects.buildingMultiplier = N(1);
                    }, duration * 1000);
                },
                applyBuildingCostReduction(factor, duration) {
                    this.goldenPeiEffects.buildingCostReduction = N(factor);
                    this.startEffectTimer('buildingCostReduction', () => {
                        this.goldenPeiEffects.buildingCostReduction = N(1);
                    }, duration * 1000);
                },
                applyUpgradeCostReduction(factor, duration) {
                    this.goldenPeiEffects.upgradeCostReduction = N(factor);
                    this.startEffectTimer('upgradeCostReduction', () => {
                        this.goldenPeiEffects.upgradeCostReduction = N(1);
                    }, duration * 1000);
                },
                boostRandomBuilding(multiplier, duration) {
                    const buildingsWithQuantity = this.buildings.filter(b => b.quantity.gt(0));
                    if (buildingsWithQuantity.length === 0) return;
                    const randomBuilding = buildingsWithQuantity[
                        Math.floor(Math.random() * buildingsWithQuantity.length)
                    ];

                    this.goldenPeiEffects.randomBuildingBoost = randomBuilding.id;

                    this.startEffectTimer('randomBuildingBoost', () => {
                        this.goldenPeiEffects.randomBuildingBoost = null;
                    }, duration * 1000);
                },
                gainProduction(seconds) {
                    const production = this.peiPerSecond.mul(seconds);
                    this.peiCount = this.peiCount.add(production);
                    this.thisAscendPei = this.thisAscendPei.add(production);
                    this.totalLifetimePei = this.totalLifetimePei.add(production);
                },
                gainClicks(count) {
                    const total = this.peiPerClick.mul(count);
                    this.peiCount = this.peiCount.add(total);
                },
                gainCandy() {
                    this.sugar = this.sugar.add(1);
                },
                selectRandomEffect(effects) {
                    const totalWeight = effects.reduce((sum, e) => sum + e.chance, 0);
                    let random = Math.random() * totalWeight;
                    for (const effect of effects) {
                        if (random < effect.chance) return effect;
                        random -= effect.chance;
                    }
                    return effects[0];
                },
                startEffectTimer(name, callback, duration) {
                    if (this.effectTimers[name]) {
                        clearTimeout(this.effectTimers[name]);
                    }
                    this.effectTimers[name] = setTimeout(() => {
                        callback();
                        delete this.effectTimers[name];
                    }, duration);
                },
                showEffectNotification(effectName) {
                    this.effect = effectName;
                    document.getElementById('effectSpan').innerHTML = effectName;
                    const toast = document.createElement('div');
                    toast.className = 'effect-toast';
                    toast.innerHTML = `
                        <span>获得金佩勒效果:${effectName}</span>
            `       ;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                },
                buyBuilding(index) {
                    let building = this.buildings[index];
                    let amount = parseInt(this.bulkAmount);
                    let totalCost = this.calcBulkCost(index);
                    if (this.peiCount.lt(totalCost)) return;
                    // 执行购买
                    if(this.hypercendU[1].level.lt(1)) this.peiCount = this.peiCount.sub(totalCost);
                    building.quantity = building.quantity.add(amount);
                    // 更新下次购买价格（使用公式代替循环）
                    building.cost = building.baseCost.mul(Decimal.pow(1.148698354997035, building.quantity));
                    // 检查成就
                    this.checkAchievements(index + 1);
                },
                buyMaxBuilding(index) {
                    let building = this.buildings[index];
                    let r = 1.148698354997035;
                    let maxAmount = this.peiCount.div(this.buildingCostMult).div(building.cost).mul(r-1).add(1).log(r);
                    let a = Decimal.max(Decimal.floor(maxAmount),0);
                    let totalCost = Decimal.pow(r,a).sub(1).mul(building.cost).div(r-1).mul(this.buildingCostMult);
                    if (this.peiCount.lt(totalCost)) return;
                    this.peiCount = this.peiCount.sub(totalCost);
                    building.quantity = building.quantity.add(a);
                    building.cost = building.baseCost.mul(Decimal.pow(r, building.quantity));
                    this.checkAchievements(index + 1);
                },
                buyAllBuilding() {
                    if (this.hypercendU[1].level.lt(1)) {for(let i=41;i>=0;i--) this.buyMaxBuilding(i);}
                    else {
                        for(let i=41;i>=0;i--) {
                            let building = this.buildings[i];
                            if (this.peiCount.lt(building.cost.mul(this.buildingCostMult))) return;
                            let r = 1.148698354997035;
                            building.quantity = N(Math.floor(this.peiCount.div(this.buildingCostMult).div(building.baseCost).max(1).log(r)+1));
                            building.cost = building.baseCost.mul(Decimal.pow(r, building.quantity));
                        }
                    }
                },
                calcBulkCost(index) {
                    let building = this.buildings[index];
                    let r = 1.148698354997035; // 价格增长系数
                    let n = parseInt(this.bulkAmount);
                    let a1 = building.cost;
                    if (n == 1) return a1.mul(this.buildingCostMult);
                    // 使用等比数列求和公式：S = a1*(r^n - 1)/(r - 1)
                    return Decimal.pow(r,n).sub(1).mul(a1).div(r-1).mul(this.buildingCostMult);
                },
                canBulkBuy(index) {
                    return this.peiCount.gte(this.calcBulkCost(index));
                },
                buyUpgrade(i, b) {
                    let upgrade = this.upgrades.filter(u => u.id == i && u.buildingId == b)
                    let c = upgrade[0].cost.mul(this.upgradeCostMult);
                    if (this.peiCount.gte(c)) {
                        this.peiCount = this.peiCount.sub(c);
                        this.upgrades.filter(u => u.id == i && u.buildingId == b).map(u => u.unlocked = true);
                    }
                },
                // 判断是否可以购买升级
                canBuyUpgrade(upgrade) {
                    let c = upgrade.cost.mul(this.upgradeCostMult);
                    return this.peiCount.gte(c) & !upgrade.unlocked
                },
                showUpgrade(u) {
                    if(this.upgShowType==1){
                        if (u.unlocked) return false;
                        else return ((u.buildingId < 100 && this.buildings[u.buildingId - 1].quantity.gte(u.required)) 
                    || (u.buildingId == 101 && this.totalClickPei.gte(u.required)) 
                    || (u.buildingId == 102 && N(this.unlockedAchievementsCount).gte(u.required)) 
                    || (u.buildingId == 103 && this.buildings[u.id + 1].quantity.gte(u.required)) 
                    || (u.buildingId == 104 && this.ascendU[0].level.gte(1)) 
                    || (u.buildingId == 105 && this.ascendU[2].level.add(this.transcendU[18].level).gte(u.required) && this.thisAscendPei.gte(u.cost)) 
                    || (u.buildingId == 106 && this.buildings[41].quantity.gte(u.required) && u.id<=16)
                    || (u.buildingId == 107 && this.goldenPeiClick >= u.required)
                    || (u.buildingId == 108 && this.ascendU[11].level.gte(1) && this.buildings[u.id + 1].quantity.gte(15))
                    || (u.buildingId == 109 && this.ascendU[11].level.gte(2) && this.buildings[u.id + 1].quantity.gte(75))
                    || (u.buildingId == 110 && this.transcendU[19].level.gte(u.required) && this.thisAscendPei.gte(u.cost))
                        );
                    }
                    else if(this.upgShowType==2){
                        return u.unlocked;
                    }
                },
                buyAllUpgrades() {
                    this.upgrades.forEach(u => {
                        if (this.showUpgrade(u)) {
                            this.buyUpgrade(u.id, u.buildingId);
                        }
                    });
                },
                checkAchievements(buildingIndex) {
                    const relatedAchievements = this.achievements.filter(
                        a => a.buildingId === buildingIndex
                    );
                    if (buildingIndex < 100) {
                        const building = this.buildings[buildingIndex-1];
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & building.quantity.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 101) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.totalLifetimePei.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 102) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.peiPerSecond.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 103) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.totalClickPei.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 104) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.totalRealityShards.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 105) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.totalTranscendPoints.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                    if (buildingIndex == 106) {
                        relatedAchievements.forEach(achievement => {
                            if (!achievement.unlocked & this.totalHypercendPoints.gte(achievement.required)) {
                                achievement.unlocked = true;
                                this.showAchievementToast(achievement);
                            }
                        });
                    }
                },
                showAchievementToast(achievement) {
                    const toast = document.createElement('div');
                    toast.className = 'achievement-toast';
                    toast.innerHTML = `
                <span>成就 </span>
                <strong>${achievement.buildingId}-${achievement.id}</strong>
                <span> 已解锁</span>`
                    ;
                    document.body.appendChild(toast);
                    this.milk = this.milk.add(this.breakCount.gte(3)?2:1);
                    setTimeout(() => {
                        toast.remove();
                    }, 5000);
                },
                ascend() {
                    // 计算获得的碎片
                    const gained = this.totalShards.sub(this.totalRealityShards).max(0);
                    this.realityShards = this.realityShards.add(gained);
                    this.totalRealityShards = this.totalShards.max(this.totalRealityShards);
                    this.ascensionCount = this.ascensionCount.add(1);
                    // 重置游戏状态
                    this.peiCount = N(0);
                    this.thisAscendPei = N(0);
                    this.buildings.forEach(b => {
                        b.quantity = N(0);
                        b.cost = b.baseCost;
                        b.production = b.baseProd;
                    });
                    this.upgrades.forEach(u => {
                        u.unlocked = false;
                    });
                    if(this.ascendU[4].level.gte(1)) this.buildings[0].quantity=N(10);
                    if(this.ascendU[4].level.gte(2)) this.buildings[1].quantity=N(10);
                    if(this.transcendU[12].level.gte(1)) this.buildings[0].quantity=N(100);
                    if(this.transcendU[12].level.gte(1)) this.buildings[1].quantity=N(100);
                    if(this.breakCount.gte(1)) this.buildings[0].quantity=N(1000);
                    if(this.breakCount.gte(1)) this.buildings[1].quantity=N(1000);
                    for(let i=1; i<=this.ascendU[6].level.toNumber(); i++) this.upgrades[1070+i].unlocked=true;
                },
                buyAscendU(index) {
                    const upgrade = this.ascendU[index];
                    if (upgrade.level.gte(upgrade.maxLevel)) return;

                    if (this.realityShards.gte(upgrade.cost)) {
                        this.realityShards = this.realityShards.sub(upgrade.cost);
                        this.ascendU[index].level = this.ascendU[index].level.add(1);
                    }
                    let a0=[1,3,5,7,50,77,100,777,999,9000,99999,222222,399999,1.5e7,1e8,2e8,1e9,1.92e9,9e9,1e10]
                    let p=[0,1334,10,0,0,0,100,0,0,0,0,2e6,0,0,0,2e8,0,0,0,0]
                    let q=[1,1,1,7,100,10,100,10,100,1e9,2,1,1,1,4,1000,10,1,1000,1]
                    this.ascendU[index].cost = index==19?this.ascendU[19].level.add(3).pow(7).mul(1.5e7):N(a0[index]).add(this.ascendU[index].level.mul(p[index])).mul(Decimal.pow(q[index],this.ascendU[index].level))
                },
                buyAllAscendU() {
                    this.ascendU.forEach(u => {
                        for(let i=0;i<u.maxLevel.toNumber();i++) this.buyAscendU(u.id-1);
                    });
                },
                refundAscendU() {
                    var confirm=window.confirm("确认回退所有飞升升级吗？这将进行一次无奖励的飞升重置！");
                    if(!confirm) return;
                    this.ascendU.forEach(u => {
                        u.level=N(0);
                    });
                    this.realityShards=this.totalRealityShards;
                    this.ascend();
                },
                transcend() {
                    const gain = this.totalTP.sub(this.totalTranscendPoints).max(0);
                    this.transcendPoints = this.transcendPoints.add(gain);
                    this.totalTranscendPoints = this.totalTP.max(this.totalTranscendPoints);
                    this.transcensionCount = this.transcensionCount.add(1);

                    this.peiCount = N(0);
                    this.thisAscendPei = N(0);
                    this.totalClickPei = N(0);
                    this.totalLifetimePei = N(0);
                    this.enableClick=true;
                    this.enableGolden=true;
                    this.buildings.forEach(b => {
                        b.quantity = N(0);
                        b.cost = b.baseCost;
                        b.production = b.baseProd;
                    });
                    this.upgrades.forEach(u => u.unlocked = false);
                    this.ascensionCount = N(1);
                    this.realityShards = N(1);
                    this.totalRealityShards=N(1);
                    this.ascendU.forEach(u => u.level = N(0));
                    if(this.transcendU[12].level.gte(1)) this.buildings[0].quantity=N(100);
                    if(this.transcendU[12].level.gte(1)) this.buildings[1].quantity=N(100);
                    if(this.breakCount.gte(1)) this.buildings[0].quantity=N(1000);
                    if(this.breakCount.gte(1)) this.buildings[1].quantity=N(1000);
                    this.updateCost();
                },
                buyTranscendU(index) {
                    const upgrade=this.transcendU[index];
                    if ((upgrade.maxLevel.gt(0) & upgrade.level.gte(upgrade.maxLevel)) | this.transcendPoints.lt(upgrade.cost)) return;
                    this.transcendPoints = this.transcendPoints.sub(upgrade.cost);
                    upgrade.level = upgrade.level.add(1);
                    let r=[1,1,1,1,1,1,1,1,1,1,1,1,10,100,1000,10000,1e5,1e5,1e6,1e6];
                    let s=[2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,4,4,10,1e6]
                    this.transcendU[index].cost=Decimal.pow(s[index],this.transcendU[index].level).mul(r[index]);
                },
                buyAllTranscendU(){
                    for(let i=0;i<12;i++) {
                        this.transcendU[i].level=this.transcendU[i].level.max(Math.floor(this.transcendPoints.log(2)+1));
                        this.transcendU[i].cost=Decimal.pow(2,this.transcendU[i].level);
                    }
                    this.transcendU.forEach(u => {
                        for(let i=0;i<u.maxLevel.toNumber();i++) this.buyTranscendU(u.id-1);
                    })
                },
                refundTranscendU() {
                    var confirm=window.confirm("确认回退所有轮回神器和升级吗？这将进行一次无奖励的轮回重置！");
                    if(!confirm) return;
                    this.transcendU.forEach(u => {
                        u.level=N(0);
                    });
                    this.transcendPoints=this.totalTranscendPoints;
                    this.transcend();
                },
                breakReset(){
                    this.peiCount = N(0);
                    this.thisAscendPei = N(0);
                    this.totalClickPei = N(0);
                    this.totalLifetimePei = N(0);
                    this.enableClick=true;
                    this.enableGolden=true;
                    this.buildings.forEach(b => {
                        b.quantity = N(0);
                        b.cost = b.baseCost;
                        b.production = b.baseProd;
                    });
                    this.upgrades.forEach(u => u.unlocked = false);
                    this.ascensionCount = N(1);
                    this.realityShards = N(1);
                    this.totalRealityShards=N(1);
                    this.ascendU.forEach(u => u.level = N(0));
                    this.transcendCount = N(1);
                    this.transcendPoints = N(1);
                    this.totalTranscendPoints = N(1);
                    this.transcendU.forEach(u => u.level=N(0));
                    this.buildings[0].quantity=N(1000);
                    this.buildings[1].quantity=N(1000);
                    this.updateCost();
                    this.milk = N(this.unlockedAchievementsCount).mul(this.breakCount.gte(2)?2:1);
                    if(this.breakCount.lte(0)) alert('你破碎了这个佩干宇宙，因此出现了4个新的选项卡。  佩勒：这次你可能早些时候就明白了，飞升轮回直到破碎，都是你自己创造的。由你自身思绪的残余所构成的事物，暗示了这一点。但是，你从未想过那会是你，对吧？');
                },
                doBreak(){
                    this.breakReset();
                    this.breakCount=this.breakCount.add(1);
                },
                buyAuto(index){
                    const upgrade=this.automation[index];
                    if(this.peiCount.lt(upgrade.cost)) return;
                    this.peiCount=this.peiCount.sub(upgrade.cost);
                    upgrade.unlocked=true;
                },
                toggleAuto(index){
                    const upgrade=this.automation[index];
                    if(!upgrade.unlocked) return;
                    upgrade.activate=!upgrade.activate;
                },
                hypercend(){
                    this.hypercendPoints = this.hypercendPoints.add(this.HPGain);
                    this.totalHypercendPoints = this.totalHypercendPoints.add(this.HPGain);
                    this.maxHypercendPoints = this.maxHypercendPoints.max(this.HPGain);
                    this.hypercendCount =  this.hypercendCount.add(1);
                    this.breakReset();
                },
                buyHypercendU(index){
                    const upgrade=this.hypercendU[index];
                    if (this.hypercendPoints.lt(upgrade.cost) | upgrade.level.gte(upgrade.maxLevel)) return;
                    this.hypercendPoints = this.hypercendPoints.sub(upgrade.cost);
                    upgrade.level = upgrade.level.add(1);
                    let t=[1,1e6,1e12,1e18,1e24,1e60]
                    this.hypercendU[index].cost=Decimal.pow(1.148698354997035,upgrade.level).mul(t[index]);
                },
                buyMaxHypercendU(index){
                    for(let i=1;i<=100;i++) this.buyHypercendU(index);
                },
                buyHyperChargeU(index){
                    const upgrade=this.hyperChargeU[index];
                    if (this.hypercendPoints.lt(upgrade.cost) | upgrade.unlocked) return;
                    this.hypercendPoints = this.hypercendPoints.sub(upgrade.cost);
                    upgrade.unlocked=true;
                },
                hyperEffect(tier){
                    if(tier == 0) return this.hyperCharge.add(1).pow(2).mul(this.breakCount.gte(30)?Decimal.pow(1.25,this.breakCount.sub(29).min(91)):1);
                    else if(tier == 1) return this.totalHypercendPoints.add(1).pow(1.4);
                    else if(tier == 2) return this.maxHypercendPoints.add(1).pow(1.4);
                    else if(tier == 3) return this.hypercendPoints.add(1).pow(1.4);
                    else if(tier == 4) return this.transcendPoints.add(1).pow(0.033);
                    else if(tier == 5) return this.HPGain.add(1).pow(0.4);
                    else if(tier == 6) return this.transcendPoints.add(1).pow(0.033);
                    else if(tier == 7) return this.maxHypercendPoints.add(1).pow(0.2);
                    else if(tier == 8) return this.sugar.add(1).pow(0.25);
                    else if(tier == 9) return this.transcendPoints.add(1).pow(0.1);
                    else if(tier == 10) return N(1);
                    else if(tier == 11) return this.sugar.add(1).pow(0.25);
                    else if(tier == 12) return this.transcendPoints.add(1).pow(1/1111);
                    else if(tier == 13) return this.transcendPoints.add(1).pow(1/1111);
                    else if(tier == 14) return this.transcendPoints.add(1).pow(1/3333);
                    else if(tier == 15) return this.transcendPoints.add(1).pow(1/3333);
                    else if(tier == 16) return this.transcendPoints.add(1).pow(1/3333);
                    else return N(1);
                },
                spaceReset() {
                    if (!this.canSpaceReset) return;
                    this.nutCount = this.nutCount.add(this.nutGain);
                    this.peiCount = N(0);
                    this.totalLifetimePei=N(0);
                    this.thisAscendPei = N(0);
                    this.totalClickPei=N(0);
                    this.sugar=N(0);
                    this.realityShards = N(1);
                    this.totalRealityShards = N(1);
                    this.transcendPoints = N(1);
                    this.totalTranscendPoints = N(1);
                    this.breakCount=N(1);
                    this.hypercendPoints=N(1);
                    this.totalHypercendPoints=N(1);
                    this.maxHypercendPoints=N(1);
                    this.hyperCharge = N(0);
                    this.buildings.forEach(b => { b.quantity = N(0); });
                    this.upgrades.forEach(u => { u.unlocked=false; });
                    this.ascendU.forEach(au => { au.level = N(0); });
                    this.transcendU.forEach(tu => { tu.level = N(0); });
                    this.hypercendU.forEach(hu => { hu.level = N(0); });
                    this.hyperChargeU.forEach(hcu => { hcu.unlocked = false; })
                    this.automation.forEach(a => {a.unlocked=false; a.activate=false;});
                    this.fosskie=N(0);
                    this.totalFosskie=N(0);
                    this.resetFosskie=N(0);
                    this.spaceResetCount = this.spaceResetCount.add(1);
                    this.updateCost();
                },
                buySpaceUpgrade(id) {
                    const upgrade = this.spaceUpgrades.find(u => u.id === id);
                    if (!upgrade || this.nutCount.lt(upgrade.cost)) return;
                    
                    this.nutCount = this.nutCount.sub(upgrade.cost);
                    upgrade.level = upgrade.level.add(1);
                    upgrade.cost = Decimal.pow(1.5,upgrade.level).ceil(); // 简单的成本增长
                },
                getSpaceUpgrade(id) {
                    return this.spaceUpgrades.find(u => u.id === id);
                },

                //中生代山谷
                calcLifeBulkCost(index, amount) {
                    const pei = this.peiLives[index];
                    const r = 1.148698354997035;
                    const a1 = pei.baseCost.mul(Decimal.pow(r, pei.level));
                    if (amount === 1) return a1.div(this.calcCostMult(index));
                    return a1.mul(Decimal.pow(r, amount).sub(1)).div(r - 1).div(this.calcCostMult(index));
                },
                buyPeiLife(index, amount) {
                    const cost = this.calcLifeBulkCost(index, amount);
                    if (this.fosskie.gte(cost)) {
                        this.fosskie = this.fosskie.sub(cost);
                        this.peiLives[index].level = this.peiLives[index].level.add(amount);
                    }
                },
                buyMaxPeiLife(){
                    for(let i=0;i<27;i++) {
                        let amount=Math.floor(this.fosskie.mul(this.calcCostMult(i)).div(this.peiLives[i].baseCost).mul(1.148698354997035).max(1).log(1.148698354997035));
                        this.peiLives[i].level = this.peiLives[i].level.max(amount);
                        if(this.peiLives[i].auto & this.peiLives[i].level.gte(1)) this.startLifeProd(i);
                    }
                },
                startLifeProd(index) {        
                    let last =Date.now();
                    const updateProgress = () => {
                        let now = Date.now();
                        
                        const delta = (now - last) / 1000;
                        this.peiLives[index].progress += delta * this.calcSpeedMult(index).toNumber();
                        
                        if (this.peiLives[index].progress >= this.peiLives[index].duration) {
                            this.fosskie = this.fosskie.add(this.calcLifeProd(index).mul(Math.floor(this.peiLives[index].progress/this.peiLives[index].duration)));
                            this.totalFosskie = this.totalFosskie.add(this.calcLifeProd(index));
                            this.resetFosskie = this.resetFosskie.add(this.calcLifeProd(index));
                            this.peiLives[index].progress = this.peiLives[index].progress % this.peiLives[index].duration;
                            cancelAnimationFrame(this.peiLives[index].timer);
                            if(this.peiLives[index].auto) this.startLifeProd(index);
                        } else {
                            this.peiLives[index].timer = requestAnimationFrame(updateProgress);
                        }
                        last = now;
                    };
                    updateProgress();
                },
                calcLifeProd(index){
                    return this.peiLives[index].level.mul(this.peiLives[index].baseProd).mul(this.calcLifeMult(index));
                },
                calcLifeCost(index){
                    return Decimal.pow(1.148698354997035,this.peiLives[index].level).mul(this.peiLives[index].baseCost);
                },
                calcLifeMult(index){
                    return Decimal.pow(1e20, this.peiLives[index].level.div(500).floor())
                    .mul(this.breakCount.gte(400)?this.breakCount.div(100).add(1):N(1))
                    .mul(Decimal.pow(2, this.traits[index].level))
                    .mul(index%3==0?Decimal.pow(2,this.traits[27].level):index%3==1?Decimal.pow(2,this.traits[28].level):Decimal.pow(2,this.traits[29].level));
                },
                calcSpeedMult(index){
                    return (this.breakCount.gte(600)?this.breakCount.div(100).add(1):N(1))
                    .mul(index/3%3<1?Decimal.pow(2,this.traits[30].level):index/3%3<2?Decimal.pow(2,this.traits[31].level):Decimal.pow(2,this.traits[32].level));
                },
                calcCostMult(index){
                    return (index/9%3<1?Decimal.pow(2,this.traits[33].level):index/9%3<2?Decimal.pow(2,this.traits[34].level):Decimal.pow(2,this.traits[35].level));
                
                },
                unlockLifeAuto(index){
                    if (this.fosskie.lt(this.peiLives[index].baseCost.mul(10))) return;
                    this.peiLives[index].auto = true;
                    this.startLifeProd(index);
                    this.fosskie = this.fosskie.sub(this.peiLives[index].baseCost.mul(10));
                },
                buyTrait(index){
                    if(this.traits[index].tier == 1 ){
                        if(this.icing.lt(this.traits[index].cost)) return;
                        this.icing = this.icing.sub(this.traits[index].cost);
                    }
                    else if(this.traits[index].tier == 2){
                        if(this.honey.lt(this.traits[index].cost)) return;
                        this.honey = this.honey.sub(this.traits[index].cost);
                    }
                    else if(this.traits[index].tier == 3){
                        if(this.caramel.lt(this.traits[index].cost)) return;
                        this.caramel = this.caramel.sub(this.traits[index].cost);
                    }
                    else return;
                    this.traits[index].level = this.traits[index].level.add(1);
                    this.traits[index].cost = Decimal.pow(3, this.traits[index].level).sub(1);
                },
                buyMaxTrait1(){
                    for(let i=0;i<27;i++) {
                        let amount=Math.floor(this.icing.add(1).log(3)+1);
                        this.traits[i].level = this.traits[i].level.max(amount);
                        this.traits[i].cost = Decimal.pow(3, this.traits[i].level).sub(1);
                    }
                },
                buyMaxTrait2(){
                    for(let i=27;i<39;i++) {
                        let amount=Math.floor(this.honey.add(1).log(3)+1);
                        this.traits[i].level = this.traits[i].level.max(amount);
                        this.traits[i].cost = Decimal.pow(3, this.traits[i].level).sub(1);
                    }
                },
                icingReset() {
                    if (this.totalFosskie.lt(1e12)) return;
                    this.icing = this.icing.add(this.icingGain);
                    this.totalIcing = this.totalIcing.add(this.icingGain);
                    this.fosskie = N(0);
                    this.resetFosskie = N(0);
                    this.peiLives.forEach(pei => {
                        pei.level = N(0);
                    });
                    for(let i=0;i<27;i++) {cancelAnimationFrame(this.peiLives[i].timer);this.peiLives[i].progress = 0;}
                },
                honeyReset() {
                    if (this.totalFosskie.lt(1e48)) return;
                    this.honey = this.honey.add(this.honeyGain);
                    this.totalHoney = this.totalHoney.add(this.honeyGain);
                    this.icing = N(0);
                    this.totalIcing = N(0);
                    this.fosskie = N(0);
                    this.resetFosskie = N(0);
                    this.peiLives.forEach(pei => {
                        pei.level = N(0);
                    });
                    for(let i=0;i<27;i++) {this.traits[i].level = N(0);
                        this.traits[i].cost = Decimal.pow(3, this.traits[i].level).sub(1);
                        cancelAnimationFrame(this.peiLives[i].timer);
                        this.peiLives[i].progress = 0;}
                },

                //超越


                //探索中心


                //杂项
                format(decimal) {
                    let e = decimal.exponent.toFixed(0);
                    let m = decimal.mantissa.toFixed(3);
                    let ee = Math.floor(Math.log10(decimal.exponent)).toFixed(0);
                    let mm = (decimal.exponent / Math.pow(10, ee)).toFixed(3);
                    if(m == "10.000") m = "9.999";
                    if (mm == "10.000") mm = "9.999";
                    if (decimal.lt(10)) return decimal.toFixed(3);
                    if (decimal.lt(100)) return decimal.toFixed(2);
                    if (decimal.lt(1000)) return decimal.toFixed(1);
                    else if (decimal.lt(1e12)) return this.comma(decimal);
                    else if (decimal.lt("1e1000000000000")) return m + "e" + this.comma(e);
                    else if (decimal.lt("1e9000000000000000")) return m + "e" + mm + "e" + ee;
                    else return "END"
                },
                formatInt(decimal) {
                    let e = decimal.exponent.toFixed(0);
                    let m = decimal.mantissa.toFixed(3);
                    let ee = Math.floor(Math.log10(decimal.exponent)).toFixed(0);
                    let mm = (decimal.exponent / Math.pow(10, ee)).toFixed(3);
                    if (m == "10.000") m = "9.999";
                    if (mm == "10.000") mm = "9.999";
                    else if (decimal.lt(1e12)) return this.comma(decimal);
                    else if (decimal.lt("1e1000000000000")) return m + "e" + this.comma(e);
                    else if (decimal.lt("1e9000000000000000")) return m + "e" + mm + "e" + ee;
                    else return "END"
                },
                comma(num) {
                    if (num === null || num === undefined) return "END"
                    let init = num.toString()
                    let portions = init.split(".")
                    portions[0] = portions[0].replace(/(\d)(?=(\d\d\d)+(?!\d))/g, "$1,")
                    return portions[0]
                },
                saveData() {
                // 1. 获取原始数据
                    return{
                        peiCount: this.peiCount,
                        thisAscendPei: this.thisAscendPei,
                        totalLifetimePei: this.totalLifetimePei,
                        totalClickPei: this.totalClickPei,
                        goldenPeiClick: this.goldenPeiClick,
                        enableClick: this.enableClick,
                        enableGolden: this.enableGolden,
                        ascensionCount: this.ascensionCount,
                        realityShards: this.realityShards,
                        totalRealityShards: this.totalRealityShards,
                        transcensionCount: this.transcensionCount,
                        transcendPoints: this.transcendPoints,
                        totalTranscendPoints: this.totalTranscendPoints,
                        breakCount: this.breakCount,
                        hypercendCount: this.hypercendCount,
                        hypercendPoints: this.hypercendPoints,
                        totalHypercendPoints: this.totalHypercendPoints,
                        maxHypercendPoints: this.maxHypercendPoints,
                        hyperCharge: this.hyperCharge,
                        nutCount: this.nutCount,
                        spaceResetCount: this.spaceResetCount,
                        spaceRecord: this.spaceRecord,

                        fosskie: this.fosskie,
                        totalFosskie: this.totalFosskie,
                        resetFosskie: this.resetFosskie,
                        icing: this.icing,
                        totalIcing: this.totalIcing,
                        honey: this.honey,
                        totalHoney: this.totalHoney,
                        caramel: this.caramel,
                        totalCaramel: this.totalCaramel,
                        milk: this.milk,
                        sugar: this.sugar,
                        playTime: this.playTime,
                        totalPlayTime: this.totalPlayTime,
                        lastUpdateTime: Date.now(),
                        
                        buildings: this.buildings.map(b => ( b.quantity )),
                        upgrades: this.upgrades.map(u => ( u.unlocked )),
                        achievements: this.achievements.map(a => ( a.unlocked )),
                        automationu: this.automation.map(u => (u.unlocked)),
                        automationa: this.automation.map(a => (a.activate)),
                        ascendU: this.ascendU.map(au => ( au.level )),
                        transcendU: this.transcendU.map(tu => (tu.level)),
                        hypercendU: this.hypercendU.map(hu => (hu.level)),
                        hyperChargeU: this.hyperChargeU.map(hu => (hu.unlocked)),
                        spaceUpgrades: this.spaceUpgrades.map(u => (u.level)),

                        peiLives: this.peiLives.map(pl => (pl.level)),
                        peiLivesAuto: this.peiLives.map(pl => (pl.auto)),
                        traits: this.traits.map(t => (t.level)),
                    }
                },
                loadData(save){
                    this.peiCount = save.peiCount || N(0);
                    this.thisAscendPei = save.thisAscendPei || N(0);
                    this.totalLifetimePei = save.totalLifetimePei || N(0);
                    this.totalClickPei = save.totalClickPei || N(0);
                    this.goldenPeiClick = save.goldenPeiClick || 0;
                    this.enableClick=save.enableClick || true;
                    this.enableGolden=save.enableGolden || true;
                    this.ascensionCount = save.ascensionCount || N(0);
                    this.realityShards = save.realityShards || N(0);
                    this.totalRealityShards = save.totalRealityShards || N(0);
                    this.transcensionCount = save.transcensionCount || N(0);
                    this.transcendPoints = save.transcendPoints || N(0);
                    this.totalTranscendPoints = save.totalTranscendPoints || N(0);
                    this.breakCount = save.breakCount || N(0);
                    this.hypercendCount = save.hypercendCount || N(0);
                    this.hypercendPoints = save.hypercendPoints || N(0);
                    this.totalHypercendPoints = save.totalHypercendPoints || N(0);
                    this.maxHypercendPoints = save.maxHypercendPoints || N(0);
                    this.hyperCharge = save.hyperCharge || N(0);
                    this.nutCount = save.nutCount || N(0);
                    this.spaceResetCount = save.spaceResetCount || N(0);
                    this.spaceRecord = save.spaceRecord || N(0);

                    this.fosskie = save.fosskie || N(0);
                    this.totalFosskie = save.totalFosskie || N(0);
                    this.resetFosskie = save.resetFosskie || N(0);
                    this.icing = save.icing || N(0);
                    this.totalIcing = save.totalIcing || N(0);
                    this.honey = save.honey || N(0);
                    this.totalHoney = save.totalHoney || N(0);
                    this.caramel = save.caramel || N(0);
                    this.totalCaramel = save.totalCaramel || N(0);
                    this.milk = save.milk || N(0);
                    this.sugar = save.sugar || N(0);
                    this.playTime = save.playTime || 0;
                    this.totalPlayTime = save.totalPlayTime || 0;

                    this.buildings.forEach((b, index) => {
                        b.quantity = !save.buildings? N(0): save.buildings[index] || N(0);
                    });
                    this.upgrades.forEach((u, index) => {
                        u.unlocked = !save.upgrades? false:save.upgrades[index] || false;
                    });
                    this.achievements.forEach((a, index) => {
                        a.unlocked = !save.achievements? false:save.achievements[index] || false;
                    });
                    this.automation.forEach((a, index) => {
                        a.unlocked = !save.automationu? false:save.automationu[index] || false;
                        a.activate = !save.automationa? false:save.automationa[index] || false;
                    });
                    this.ascendU.forEach((au, index) => {
                        au.level = !save.ascendU? N(0):save.ascendU[index] || N(0);
                    });
                    this.transcendU.forEach((tu, index) => {
                        tu.level = !save.transcendU? N(0):save.transcendU[index] || N(0);
                    });
                    this.hypercendU.forEach((hu, index) => {
                        hu.level = !save.hypercendU? N(0):save.hypercendU[index] || N(0);
                    });
                    this.hyperChargeU.forEach((hu, index) => {
                        hu.unlocked = !save.hyperChargeU? false:save.hyperChargeU[index] || false;
                    });
                    this.spaceUpgrades.forEach((su, index) => {
                        su.level = !save.spaceUpgrades? N(0):save.spaceUpgrades[index] || N(0);
                    })

                    this.peiLives.forEach((pl, index) => {
                        pl.level = !save.peiLives? N(0):save.peiLives[index] || N(0);
                        pl.auto = !save.peiLivesAuto? false:save.peiLivesAuto[index] || false;
                    })
                    this.traits.forEach((t, index) => {
                        t.level = !save.traits? N(0):save.traits[index] || N(0);
                    })

                    this.updateCost();
                    this.handleOfflineProduction(save.lastUpdateTime);
                },
                saveGame() {
                    console.log(this.saveData());
                    // 2. 转换为JSON字符串
                    const save= formatsave.encode(this.saveData())
                    console.log(save);
                    // 3. 显示给用户（示例）
                    navigator.clipboard.writeText(save);
                    alert("存档代码已复制到剪贴板");
                },
                loadGame() {
                    const save = prompt("请输入存档代码");
                        // 4. 解析JSON
                    const data = formatsave.decode(save);
                    transformToDecimal(data);
                        // 5. 应用存档数据
                    this.loadData(data);
                    alert("存档加载成功！");
                    this.localSave();
                },
                localSave() {
                    localStorage.pelkieClickerSave = formatsave.encode(this.saveData());
                },
                localLoad() {
                    if (!localStorage.pelkieClickerSave) return;
                    const data = formatsave.decode(localStorage.pelkieClickerSave);
                    transformToDecimal(data);
                    console.log(data);
                    this.loadData(data);
                },
                hardReset() {
                    if (confirm("是否硬重置?这将重置你的所有进度!")) {
                        // 用户点击了确定
                        this.peiCount = N(0);
                        this.thisAscendPei = N(0);
                        this.totalLifetimePei = N(0);
                        this.totalClickPei = N(0);
                        this.peiPerSecond= N(0);
                        this.peiPerClick= N(1);
                        this.goldenPeiClick = 0;
                        this.goldenPeiTimer = 0;
                        this.enableClick=true;
                        this.enableGolden=true;
                        this.goldenPeiEffects = {
                            clickMultiplier: N(1),
                            buildingMultiplier: N(1),
                            buildingCostReduction: N(1),
                            upgradeCostReduction: N(1),
                            randomBuildingBoost: null
                        };
                        this.buildings= Array.from({ length: 42 }, (_, i) => ({
                            id: i,
                            quantity: N(0),
                            baseCost: N(10).pow(i * (i - 1) / 40 + i + 1),
                            cost: N(10).pow(i * (i - 1) / 40 + i + 1),
                            baseProd: N(8).pow(i - 1),
                            production: N(8).pow(i - 1),
                        })),
                        this.upgrades= UPGRADES.map(u => ({
                                ...u,
                                unlocked: false,
                            })),
                        this.achievements= ACHIEVEMENTS.map(a => ({
                                ...a,
                                unlocked: false,
                            })),
                        this.automation=AUTOMATION.map(a => ({
                                ...a,
                                unlocked: false,
                                activate: false,
                            })),
                        this.ascendU= ASCENDU.map(r => ({
                                ...r,
                                level: N(0),
                            })),
                        this.transcendU= TRANSCENDU.map(r => ({
                                ...r,
                                level: N(0),
                            })),
                        this.hypercendU= HYPERCENDU.map(r => ({
                                ...r,
                                level: N(0),
                            })),
                        this.hyperChargeU= HYPERCHARGEU.map(r => ({
                                ...r,
                                unlocked: false,
                            }))
                        this.spaceUpgrades= [
                            { id: 1, cost: N(1), level: N(0), maxLevel: N(10), children: [2,3] },
                            { id: 2, cost: N(1), level: N(0), maxLevel: N(10), children: [] },
                            { id: 3, cost: N(1), level: N(0), maxLevel: N(10), children: [] },
                        ],

                        this.peiLives= Array(27).fill().map((_,i) => ({
                            id: i+1,
                            level: N(0),       // 当前等级
                            progress: 0,       // 生产进度(秒)
                            auto: false,       // 自动生产
                            timer: null,
                            duration: Math.pow(10, i/10+0.4),//生产所需时间(秒)
                            baseCost: N(12).pow(i+1),//基础成本
                            baseProd: N(8).pow(i+1)//基础产量
                        })),
                        this.traits= Array(42).fill().map((_,i) => ({
                            id: i+1,
                            tier: i<27?1:i<39?2:i<42?3:0,
                            level: N(0),
                            cost: N(1)
                        })),

                        this.ascensionCount = N(0);
                        this.realityShards = N(0);
                        this.totalRealityShards = N(0);

                        this.transcensionCount = N(0);
                        this.transcendPoints = N(0);
                        this.totalTranscendPoints = N(0);

                        this.breakCount=N(0);
                        this.hypercendCount = N(0);
                        this.hypercendPoints = N(0);
                        this.totalHypercendPoints = N(0);
                        this.maxHypercendPoints = N(0);
                        this.hyperCharge = N(0);

                        this.nutCount = N(0);
                        this.spaceResetCount = N(0);
                        this.spaceRecord = N(0);

                        this.fosskie = N(0);
                        this.totalFosskie = N(0);
                        this.resetFosskie = N(0);

                        this.icing = N(0);
                        this.totalIcing = N(0);
                        this.honey = N(0);
                        this.totalHoney = N(0);
                        this.caramel = N(0);
                        this.totalCaramel = N(0);

                        this.milk = N(0);
                        this.sugar = N(0);
                        this.playTime = 0;
                        this.totalPlayTime = 0;
                        this.lastUpdateTime= Date.now();

                        this.localSave();
                        this.currentArea=1;
                    }
                    else return;
                },
                handleOfflineProduction(savedTime) {
                    if (!savedTime) return;

                    const currentTime = Date.now();
                    const offlineTime = Math.min(currentTime - savedTime, this.ascendU[3].level.toNumber() * 21600000 + 21600000);
                    const offlineSeconds = offlineTime / 1000;

                    if (offlineSeconds > 1) {
                        // 计算离线收益
                        const production = this.totalProduction.mul(offlineSeconds*0.8);
                        this.peiCount = this.peiCount.add(production);
                        this.thisAscendPei = this.thisAscendPei.add(production);
                        this.totalLifetimePei = this.totalLifetimePei.add(production);
                        const fosskieproduction = this.fosskiePerSecond.mul(offlineSeconds*0.8);
                        this.fosskie = this.fosskie.add(fosskieproduction);
                        this.totalFosskie = this.totalFosskie.add(fosskieproduction);
                        this.resetFosskie = this.resetFosskie.add(fosskieproduction);
                        this.playTime = this.playTime + offlineSeconds;
                        this.totalPlayTime = this.totalPlayTime + offlineSeconds;
                        // 显示离线通知
                        this.showOfflineNotification(offlineSeconds, production);
                    }
                },
                showOfflineNotification(seconds, amount) {
                    const hours = Math.floor(seconds / 3600);
                    const mins = Math.floor((seconds % 3600) / 60);
                    const secs = Math.floor(seconds % 60);
                    const toast = document.createElement('div');
                    toast.className = 'offline-toast';
                    toast.innerHTML = `
                <p>你离线了 ${hours}h${mins}m${secs}s</p>
                <p>离线产量: ${this.format(amount.div(seconds))}</p>
                <p>效率: 80%, 时长上限: ${this.ascendU[3].level.toNumber()*6+6}h</p>
                <p>获得 ${this.format(amount)} 佩干</p>
                <p>糖块计时器增加了 ${seconds} 秒</p>
            `;
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 5000);
                },
                updateCost(){
                    for(let i=0;i<42;i++) this.buildings[i].cost = this.buildings[i].baseCost.mul(new Decimal(1.148698354997035).pow(this.buildings[i].quantity));
                    let a0=[1,3,5,7,50,77,100,777,999,9000,99999,222222,399999,1.5e7,1e8,2e8,1e9,1.92e9,9e9,1e10];
                    let p=[0,1334,10,0,0,0,100,0,0,0,0,2e6,0,0,0,2e8,0,0,0,0];
                    let q=[1,1,1,7,100,10,100,10,100,1e9,2,1,1,1,4,1000,10,1,1000,1];
                    for(let i=0;i<20;i++){
                        this.ascendU[i].cost = i==19?this.ascendU[19].level.add(3).pow(7).mul(1.5e7):N(a0[i]).add(this.ascendU[i].level.mul(p[i])).mul(Decimal.pow(q[i],this.ascendU[i].level))
                    }
                    let r=[1,1,1,1,1,1,1,1,1,1,1,1,10,100,1000,10000,1e5,1e5,1e6,1e6];
                    let s=[2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,4,4,10,1e6]
                    for(let i=0;i<20;i++){
                        this.transcendU[i].cost=Decimal.pow(s[i],this.transcendU[i].level).mul(r[i]);
                    }
                    let t=[1,1e6,1e12,1e18,1e24,1e60]
                    for(let i=0;i<6;i++) this.hypercendU[i].cost=Decimal.pow(1.148698354997035,this.hypercendU[i].level).mul(t[i]);
                    this.milk = N(this.unlockedAchievementsCount).mul(this.breakCount.gte(3)?2:1);
                    for(let i=0;i<27;i++) if(this.peiLives[i].auto & this.peiLives[i].level.gte(1)) this.startLifeProd(i);
                    for(let i=0;i<42;i++) this.traits[i].cost = Decimal.pow(3, this.traits[i].level).sub(1);
                },
                // 其他方法...
            },
            computed: {
                // 带升级加成的总生产量
                sugarBonus(){
                    return this.sugar.mul(0.001).mul(this.sugarUpgradeMult).add(1)
                    .mul(this.upgrades.filter(u => u.buildingId == 110).reduce((prod, upgrade, i) => {
                        let factor = N(milkUpgradeBase[upgrade.id-1]*0.001);
                        return upgrade.unlocked ? prod.mul(factor.mul(this.sugar.min(1000)).mul(this.sugarUpgradeMult).add(1)) : prod;
                    }, N(1)))
                    .mul([2,3,4,5,6,7,8,9,10].reduce((prod,i)=>{
                        return this.ascendU[15].level.gte(i)?prod.mul(this.sugar.min(1000).mul(0.001*i).mul(this.sugarUpgradeMult).add(1)):prod;
                    },N(1)))
                },
                sugarUpgradeMult(){
                    return this.transcendU[8].level.mul(0.1).add(1)
                    .mul(this.totalFosskie.add(1).pow(0.25))
                    .mul(this.traits[38].level.mul(0.2).add(1));
                },
                milkBonus(){
                    return this.upgrades.filter(u => u.buildingId == 102).reduce((prod, upgrade, i) => {
                        let factor = N(milkUpgradeBase[upgrade.id-1]*0.001);
                        return upgrade.unlocked ? prod.mul(factor.mul(this.milk).mul(this.milkUpgradeMult).add(1)) : prod;
                    }, N(1))
                    .mul([1,2,3,4,5,6,7,8,9,10].reduce((prod,i)=>{
                        return this.ascendU[9].level.gte(i)?prod.mul(this.milk.mul(0.001*i).mul(this.milkUpgradeMult).add(1)):prod;
                    },N(1)))
                },
                milkUpgradeMult(){
                    return this.transcendU[9].level.mul(0.1).add(1)
                },
                upgradeBonus(){
                    return this.upgrades.filter(u => u.buildingId == 105).reduce((sum, upgrade) => {
                        return upgrade.unlocked ? sum.mul(N(1).add(N(upgrade.id-1).add(10).div(10).floor().div(100))) : sum;
                    }, N(1))
                    .mul(this.upgrades.filter(u => u.buildingId == 104 & u.id>=6).reduce((sum, upgrade, i) => {
                        let factor=[1.01,1.1,2,11,101]
                        return upgrade.unlocked ? sum.mul(factor[i]) : sum;
                    }, N(1)))
                    .mul(this.upgrades.filter(u => u.buildingId == 106).reduce((sum, upgrade) => {
                        return upgrade.unlocked ? sum.mul(1.1) : sum;
                    }, N(1)))
                    .mul(Decimal.pow(1.1,this.ascendU[1].level))
                    .mul(Decimal.pow(1.1+(this.breakCount.max(5).min(8).sub(4).mul(0.025).toNumber()),this.transcendU[0].level))
                    .mul(this.enableGolden&!this.transcendU[13].level.gte(1)?N(1):this.ascendU[8].level.add(this.transcendU[4].level).mul(0.1).add(1.4))
                    .mul(this.enableClick&!this.transcendU[13].level.gte(1)?N(1):this.ascendU[16].level.add(this.transcendU[4].level).mul(0.1).add(1.4));
                },
                ascendBonus(){
                    return this.upgrades.filter(u => u.buildingId == 104 & u.id<=5).reduce((sum, upgrade, i) => {
                        let factor=[0.05,0.2,0.25,0.25,0.25]
                        return upgrade.unlocked ? sum.add(this.totalRealityShards.mul(factor[i])) : sum;
                    }, N(1));
                },
                transcendBonus(){
                    return this.transcensionCount.gte(1)?this.totalTranscendPoints.add(2):N(1);
                },
                breakBonus(){
                    return Decimal.pow(4*(this.breakCount.gte(6)?2:1)*(this.breakCount.gte(7)?2:1),this.breakCount);
                },
                hypercendBonus(){
                    return this.hyperEffect(0)
                    .mul(this.breakCount.gte(15)?this.totalHypercendPoints.add(4):1);
                },
                buildingCostMult(){
                    return (this.hypercendU[3].level.gte(1)?N(0.5).div(this.transcendU[5].level.mul(0.1).add(1)):this.goldenPeiEffects.buildingCostReduction)
                    .mul(this.ascendU[10].level.mul(-0.02).add(1))
                    .mul(Decimal.pow(0.99,this.transcendU[2].level));
                },
                upgradeCostMult(){
                    return (this.hypercendU[3].level.gte(1)?N(0.5).div(this.transcendU[5].level.mul(0.1).add(1)):this.goldenPeiEffects.upgradeCostReduction)
                    .mul(this.ascendU[10].level.mul(-0.02).add(1))
                    .mul(this.ascendU[12].level.gte(1)?0.2:1)
                    .mul(Decimal.pow(0.99,this.transcendU[3].level));
                },
                baseClick() {
                    let base = N(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*177.8+1778:this.goldenPeiEffects.clickMultiplier);
                    let mult = this.upgrades.filter(u => u.buildingId == 1 && u.id < 4).reduce((prod, upgrade) => {
                        return upgrade.unlocked ? prod.mul(2) : prod;
                    }, N(1))
                    .add(this.upgrades.filter(u => u.buildingId == 1 && u.id == 4)[0].unlocked?
                        this.upgrades.filter(u => u.buildingId == 1 && u.id > 4 && u.id <= 20).reduce((prod, upgrade) => {
                            return upgrade.unlocked ? prod.mul(this.transcendU[6].level.mul(0.1).add(1).mul(this.transcendU[15].level.gte(1)?100:20)) : prod;
                        }, N(1)).mul(this.ascendU[13].level.gte(1)?1000: 1).mul(this.buildingCount):N(0))
                    .mul(this.upgrades.filter(u => u.buildingId == 101).reduce((prod, upgrade) => {
                        return upgrade.unlocked ? prod.mul(1.01) : prod;
                    }, N(1)))
                    .mul(Decimal.pow(1.1+(this.breakCount.max(5).min(8).sub(4).mul(0.025).toNumber()),this.transcendU[1].level));
                    return base.mul(mult);
                },
                totalClick(){
                    return this.baseClick.mul(this.sugarBonus).mul(this.milkBonus).mul(this.upgradeBonus)
                    .mul(this.ascendBonus).mul(this.transcendBonus).mul(this.breakBonus).mul(this.hypercendBonus)
                    .mul(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*2.2+22:this.goldenPeiEffects.buildingMultiplier);
                },
                baseProduction() {
                    let base = this.buildings.reduce((sum, building, index) => {
                        let buildingMult = N(1);
                        if (index == 0) {
                            buildingMult = this.upgrades.filter(u => u.buildingId == 1 && u.id < 4).reduce((prod, upgrade) => {
                                return upgrade.unlocked ? prod.mul(2) : prod;
                            }, N(1))
                            .add(this.upgrades.filter(u => u.buildingId == 1 && u.id == 4)[0].unlocked?
                                this.upgrades.filter(u => u.buildingId == 1 && u.id > 4 && u.id <= 20).reduce((prod, upgrade) => {
                                    return upgrade.unlocked ? prod.mul(this.transcendU[6].level.mul(0.1).add(1).mul(this.transcendU[15].level.gte(1)?100:20).mul(this.breakCount.max(4).min(8).sub(3).mul(0.2).add(1))) : prod;
                                }, N(1))
                                .mul(this.upgrades.filter(u => u.buildingId == 1 & u.id>20).reduce((prod, upgrade, i) => {
                                    return upgrade.unlocked ? prod.mul(Decimal.pow(4,this.buildings[index].quantity/100 - 10*(i+1)*(i+2))).mul(Decimal.pow(this.buildings[index].baseCost, 0.1)) : prod;
                                }, N(1)))
                                .mul(this.ascendU[13].level.gte(1)?25: 1).mul(this.buildingCount):N(0))
                            .mul(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*0.1+2:this.goldenPeiEffects.randomBuildingBoost == index ? 1.1 : 1);
                        }
                        if (index == 1) {
                            buildingMult = this.upgrades.filter(u => u.buildingId == 2).reduce((prod, upgrade) => {
                                return upgrade.unlocked ? prod.mul(this.ascendU[17].level.gte(1)?this.breakCount.gte(8)?5:3.2:2).mul(this.breakCount.max(4).min(8).sub(3).mul(0.2).add(1)) : prod;
                            }, N(1))
                            .mul(this.upgrades.filter(u => u.buildingId == 103).reduce((prod, upgrade) => {
                                return upgrade.unlocked ? prod.mul(this.ascendU[17].level.gte(1)?this.breakCount.gte(8)?5:3.2:2) : prod;
                            }, N(1)))
                            .mul(this.upgrades.filter(u => u.buildingId == 2 & u.id>20).reduce((prod, upgrade, i) => {
                                return upgrade.unlocked ? prod.mul(Decimal.pow(4,this.buildings[index].quantity/100 - 10*(i+1)*(i+2))).mul(Decimal.pow(this.buildings[index].baseCost, 0.1).mul(1e6)) : prod;
                            }, N(1)))
                            .mul(this.ascendU[18].level.mul(this.milk).mul(0.002).add(1))
                            .mul(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*0.1+2:this.goldenPeiEffects.randomBuildingBoost == index ? 1.1:1);
                        }
                        if (index >= 2) {
                            buildingMult = this.upgrades.filter(u => u.buildingId == (index + 1) & u.id<=20).reduce((prod, upgrade) => {
                                return upgrade.unlocked ? prod.mul(this.ascendU[19].level.gte(index-1)?Math.pow(this.breakCount.gte(15)?1.1:1.05,42-index)*2:2).mul(this.breakCount.max(4).min(8).sub(3).mul(0.2).add(1)) : prod;
                            }, N(1))
                            .mul(this.upgrades.filter(u => u.buildingId == (index + 1) & u.id>20).reduce((prod, upgrade, i) => {
                                return upgrade.unlocked ? prod.mul(Decimal.pow(4,this.buildings[index].quantity/100 - 10*(i+1)*(i+2))).mul(Decimal.pow(this.buildings[index].baseCost, 0.1).mul(1e6)) : prod;
                            }, N(1)))
                            .mul(this.upgrades.filter(u => u.buildingId == 103 && u.id == index - 1)[0].unlocked ? this.buildings[1].quantity.div(index - 1).div(100).mul(this.transcendU[7].level.mul(0.1).add(1)).add(1) : 1)
                            .mul(this.upgrades.filter(u => u.buildingId == 108 && u.id == index - 1      )[0].unlocked? this.buildings[index - 1      ].quantity.mul(0.01) .mul(this.transcendU[10].level.mul(0.1).add(1)).add(1):1)
                            .mul(this.upgrades.filter(u => u.buildingId == 108 && u.id == (index+37)%40+1)[0].unlocked? this.buildings[(index+37)%40+2].quantity.mul(0.001).mul(this.transcendU[10].level.mul(0.1).add(1)).add(1):1)
                            .mul(this.upgrades.filter(u => u.buildingId == 109 && u.id == index - 1      )[0].unlocked? this.buildings[index-2        ].quantity.mul(0.01) .mul(this.transcendU[11].level.mul(0.1).add(1)).add(1):1)
                            .mul(this.upgrades.filter(u => u.buildingId == 109 && u.id == (index+36)%40+1)[0].unlocked? this.buildings[(index+36)%40+2].quantity.mul(0.001).mul(this.transcendU[11].level.mul(0.1).add(1)).add(1):1)
                            .mul(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*0.1+2:this.goldenPeiEffects.randomBuildingBoost == index ? 1.1 : 1);
                        }
                        building.production = building.quantity.mul(building.baseProd).mul(buildingMult)
                        return sum.add(building.production);
                    }, N(0));
                    return base;
                },
                totalProduction(){
                    return this.baseProduction.mul(this.milkBonus).mul(this.sugarBonus).mul(this.upgradeBonus)
                    .mul(this.ascendBonus).mul(this.transcendBonus).mul(this.breakBonus).mul(this.hypercendBonus)
                    .mul(this.hypercendU[3].level.gte(1)?this.transcendU[5].level.toNumber()*2.2+22:this.goldenPeiEffects.buildingMultiplier);
                },
                buildingCount() {
                    let sum = N(0);
                    for (i = 1; i < (this.buildings.length - 1); i++) sum = sum.add(this.buildings[i].quantity);
                    return sum;
                },
                unlockedUpgradesCount() {
                    return this.upgrades.filter(u => u.unlocked).length;
                },
                unlockedAchievementsCount() {
                    return this.achievements.filter(a => a.unlocked).length;
                },
                canAscend() {
                    return this.totalLifetimePei.gte(1e12);
                },
                canTranscend(){
                    return this.totalRealityShards.gte(1e12);
                },
                canBreak(){
                    return this.totalTranscendPoints.gte(Decimal.pow(10,this.breakCount).mul(1e12));
                },
                canHypercend(){
                    return this.totalLifetimePei.gte(1e308) & this.breakCount.gte(8);
                },
                totalShards() {
                    return this.totalLifetimePei.gte(1e48) ? this.totalLifetimePei.pow(1 / 4).floor() : this.totalLifetimePei.div(1e12).pow(1 / 3).floor();
                },
                nextShards() {
                    return this.totalShards.gte(1e12) ? this.totalShards.add(1).pow(4) : this.totalShards.add(1).pow(3).mul(1e12);
                },
                totalTP(){
                    return this.totalRealityShards.gte(1e48) ? this.totalRealityShards.pow(1 / 4).floor() : this.totalRealityShards.div(1e12).pow(1 / 3).floor();
                },
                nextTP(){
                    return this.totalTP.max(this.totalTranscendPoints).gte(1e12) ? this.totalTP.max(this.totalTranscendPoints).add(1).pow(4) : this.totalTP.max(this.totalTranscendPoints).add(1).pow(3).mul(1e12);
                },
                nextBreak(){
                    return Decimal.pow(10,this.breakCount).mul(1e12);
                },
                HPGain(){
                    return Decimal.pow(this.totalLifetimePei, 1/308).div(10).min(Decimal.pow(this.totalLifetimePei, 1/1000).mul(1e6)).mul(this.HPmult).floor();
                },
                HPmult(){
                    return (this.breakCount.gte(20)?this.breakCount.mul(0.25).sub(3):N(1))
                    .mul(this.hyperChargeU[6].unlocked?this.hyperEffect(7):1)
                    .mul(this.hyperChargeU[10].unlocked?this.hyperEffect(11):1)
                    .mul(this.hyperChargeU[11].unlocked?this.hyperEffect(12):1);
                },
                HCProduction(){
                    return this.hypercendU[0].level
                    .mul(this.hypercendU[1].level.mul(0.49).add(1))
                    .mul(this.hypercendU[2].level.mul(0.19).add(1))
                    .mul(this.hypercendU[3].level.mul(0.09).add(1))
                    .mul(this.hypercendU[4].level.mul(0.04).add(1))
                    .mul(this.hypercendU[5].level.mul(0.01).add(1))
                    .mul(this.hyperChargeU[0].unlocked?this.hyperEffect(1):1)
                    .mul(this.hyperChargeU[1].unlocked?this.hyperEffect(2):1)
                    .mul(this.hyperChargeU[2].unlocked?this.hyperEffect(3):1)
                    .mul(this.hyperChargeU[3].unlocked?this.hyperEffect(4).pow(3):1)
                    .mul(this.hyperChargeU[4].unlocked?this.hyperEffect(5).pow(3):1)
                    .mul(this.hyperChargeU[5].unlocked?this.hyperEffect(6):1)
                    .mul(this.hyperChargeU[7].unlocked?this.hyperEffect(8).pow(9):1)
                    .mul(this.hyperChargeU[8].unlocked?this.hyperEffect(9):1)
                    .mul(this.hyperChargeU[9].unlocked?this.hyperEffect(4).pow(3).mul(this.hyperEffect(8).pow(9)):1)
                    .mul(this.hyperChargeU[11].unlocked?this.hyperEffect(12).pow(15):1)
                    .mul(this.breakCount.gte(25)?Decimal.pow(2,this.breakCount.sub(24).max(1).min(20)):1);
                },
                canSpaceReset(){
                    return this.totalLifetimePei.gte(1e36525) && this.totalFosskie.gte(1e84);
                },
                nutGain(){
                    return this.totalLifetimePei.pow(1/30000).mul(this.totalFosskie.max(10).log(10)/300).floor();
                },
                fosskiePerSecond(){
                    return this.peiLives.reduce((sum, p, index) => {
                        return p.auto? sum.add(p.baseProd.mul(p.level).mul(this.calcLifeMult(index).mul(this.calcSpeedMult(index)).div(p.duration))) : sum;
                    }, N(0));
                },
                fosskiePerClick(){
                    return this.fosskiePerSecond.div(20).add(1).mul(this.traits[36].level.mul(0.2).add(1));
                },
                icingGain(){
                    return this.resetFosskie.gte(1e48)? this.resetFosskie.pow(1/4).floor(): this.resetFosskie.div(1e12).pow(1/3).floor();
                },
                honeyGain(){
                    return this.resetFosskie.gte(1e192)? this.resetFosskie.pow(1/16).floor(): this.resetFosskie.div(1e48).pow(1/12).floor();
                },
                goldenPeiTimeCap(){
                    return (this.upgrades.filter(u => u.buildingId == 107 && u.id == 1)[0].unlocked ? 210 : 420) 
                    / (this.ascendU[5].level.toNumber()*0.1+1)
                    / (this.transcendU[17].level.toNumber()*0.05+1);
                },
                sugarTimeCap(){
                    return 3600 
                    / (this.ascendU[14].level.toNumber()*0.2+1)
                    / (this.transcendU[16].level.toNumber()*0.2+1)
                    / (this.traits[37].level.toNumber()*0.2+1)
                    / (this.breakCount.gte(800)?this.breakCount.toNumber()*0.001+1:1)
                    * Math.max(this.sugar.toNumber()/1000, 1);
                }
            },
            mounted() {
                this.localLoad();
                this.lastUpdate = Date.now();

                const gameLoop = () => {
                    const now = Date.now();
                    const delta = (now - this.lastUpdate) / 1000;
                    this.peiPerClick = this.totalClick;
                    this.peiPerSecond = this.totalProduction;
                    this.peiCount = this.peiCount.add(this.totalProduction.mul(delta));
                    this.thisAscendPei = this.thisAscendPei.add(this.totalProduction.mul(delta));
                    this.totalLifetimePei = this.totalLifetimePei.add(this.totalProduction.mul(delta));
                    if (this.playTime >= this.sugarTimeCap) {
                        this.sugar = this.sugar.add(this.breakCount.max(1).min(10).add(this.breakCount.gte(1000)?this.breakCount.div(1000):0));
                        this.playTime = this.playTime - this.sugarTimeCap;
                    }
                    if(this.hypercendU[0].level.gte(1)) this.hyperCharge = this.hyperCharge.add(this.HCProduction.mul(delta));
                    if(this.automation[9].activate) {
                        this.hypercendPoints = this.hypercendPoints.add(this.HPGain.mul(delta).mul(0.001));
                        this.totalHypercendPoints = this.totalHypercendPoints.add(this.HPGain.mul(delta).mul(0.001));
                        this.maxHypercendPoints = this.maxHypercendPoints.add(this.HPGain.mul(delta).mul(0.001));
                    }
                    this.lastUpdate = now;
                    requestAnimationFrame(gameLoop);
                };
                gameLoop();

                setInterval(() => {
                    this.checkAchievements(101);
                    this.checkAchievements(102);
                    this.checkAchievements(103);
                    this.checkAchievements(104);
                    this.checkAchievements(105);
                    this.checkAchievements(106);
                    if(this.automation[0].activate) this.buyAllBuilding();
                    if(this.automation[1].activate) this.buyAllUpgrades();
                    if(this.automation[2].activate) this.peiCount=this.peiCount.add(this.peiPerClick);
                    if(this.automation[3].activate) this.clickGoldenPei();
                    if(this.automation[4].activate) this.buyAllAscendU();
                    if(this.automation[5].activate) {this.realityShards=this.totalRealityShards.max(this.totalShards); this.totalRealityShards=this.totalRealityShards.max(this.totalShards);}
                    if(this.automation[6].activate) this.buyAllTranscendU();
                    if(this.automation[7].activate) {this.transcendPoints=this.totalTranscendPoints.max(this.totalTP); this.totalTranscendPoints=this.totalTranscendPoints.max(this.totalTP);}
                    if(this.automation[8].activate) {this.breakCount = this.breakCount.max(Math.floor(this.totalTranscendPoints.div(1e11).max(1).log(10)))}
                    if(this.automation[10].activate) this.buyMaxPeiLife();
                    if(this.automation[11].activate) this.buyMaxTrait1();
                    if(this.automation[12].activate) {this.fosskie = this.fosskie.add(this.fosskiePerClick);this.totalFosskie = this.totalFosskie.add(this.fosskiePerClick);this.resetFosskie = this.resetFosskie.add(this.fosskiePerClick);};
                    if(this.automation[13].activate) this.buyMaxTrait2();
                },100);

                setInterval(() => {
                    if(this.enableGolden) this.goldenPeiTimer++
                    this.playTime++;
                    this.totalPlayTime++;
                    let t = this.goldenPeiTimeCap;
                    let l = this.upgrades.filter(u => u.buildingId == 107 && u.id == 1)[0].unlocked ? 26 : 13;
                    if (this.goldenPeiTimer >= t) {
                        this.goldenPeiVisible = true;
                        setTimeout(() => {
                            this.goldenPeiVisible = false;
                        }, 1000*l);
                        this.goldenPeiTimer = 0;
                    }
                }, 1000);

                setInterval(() => {
                    this.localSave();
                },10000)
            }
        });
    </script>
</body>
</html>